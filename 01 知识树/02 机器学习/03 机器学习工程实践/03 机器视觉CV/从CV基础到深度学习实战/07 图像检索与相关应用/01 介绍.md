# 图像检索

比如 google 的以图搜图，baidu 也有这种 基于 DL 的图像检索系统。

数据的量级是很大的，在非常短时间内检索出来，实际上是比较麻烦的。

还有就是图像的相似度，比如说有的人认为颜色相似的图像比较相似，有的人认为图像里面具体的东西是类似的图像才是类似的。

比如说电商里面，搜索的时候，可能更看重一副的样式，那么这种相似实际上与普通我们认为的相似还是有些区别的。

一点基础： 基于内容的图像检索

基于图像本身包含的内容信息检索出相近的图片

![mark](http://pacdb2bfr.bkt.clouddn.com/blog/image/180812/LBIjBL8AIc.png?imageslim)

这个相近与人的主观的判断是有关系的，

13年之前，所有的图像的 这种检索系统都是基于先对图片 做一个描述，然后基于文本的相似度做一个匹配的，哪个时候还做不到对图像的内容有这么好的理解。

有人问了：如果是找同一物体的图像而不是相似的呢？淘宝上点一个商品，有两个选项：找相似、找同款，因为电商汇总很多东西就是同款的，但是颜色不同。

## CBIR

我们今天提到的系统叫 CBIR 是content base image retrieval。

主要的组件如下：

![mark](http://pacdb2bfr.bkt.clouddn.com/blog/image/180812/E466mFAhfJ.png?imageslim)

和所有的大家接触到的智能系统或者一些 ml 的这些系统都比较接近。

会有一个 offline 大的过程，然后会有一个 online 的过程。

从上面的图可以看出，我线下会对很多图片抽取特征向量，然后我线上查找的时候会对图像抽取特征向量。然后我会对这些向量进行相似度计算，去判断我请求的这些向量与我数据库中的这些向量哪些是比较接近的。然后我会范湖这个结果。

当然，上图的流程中还有一个反馈的过程。




所以，我们现在有几个核心的问题需要解决：

CBIR2个重点

需要解决的几个核心问题：

1. 用什么样的特征去表征图像内容？
    - HOG, SIFT, GIST…
    - 基于具体场景目标训练卷积神经网络
    - 提取神经网络深层输出作为特征
2. 如何定义“相近”
    - 各种距离准则
3. 高维空间里如何高效查找最近邻？
    - 近似最近邻(ANN)算法大有帮助
    - 卷积神经网络训练的同时学习分桶桶号

第一个问题，到13年才有基于图像内容的检索，之前的图像检索都是基于一些传统的特征。13年基于具体的场景目标训练出了卷积神经网络。

第二个问题就是如何根据这些特征来计算相近度，也就是相近度怎么定义。

第三个问题，在电商的体系，在淘宝一个中等的品类下一天的商品可能有 500万个，我要先识别这个东西是哪个类目，比如女性的品类下各种裙子很难区分出到底属于什么品类，我们现在假定准确率已经很高了，在一个 有 500万个商品的品类下，希望检索出比较接近的产品，与这500万个产品对比的过程还是一个比较耗时的过程，如果一个用户以图搜图，但是你用了8秒或10秒才返回结果，那么肯定没有人会使用的。

这个近似最近邻方法既有很大的帮助，可以在降低一些准确度的情况下大幅提升速度。在15年的时候CVPR有一个paper，利用卷积神经网络学习出了一个分桶，其实，这些方法大概的思路都是先对我的图像做一个分桶，然后只去找其中某个区域的图片。<span style="color:red;">什么是近似最近邻？怎么学习出一个分桶的？什么是分桶？</span>


OK，上面就是今天要重点讲的几个方面，最近的paper 也大体都是从这几个角度来考虑怎么样更好的组织，在当前的场景下，进行优化。


### 一点基础： 图像特征HOG

<span style="color:red;">这个放到之前的图像处理部分。</span>

- 方向梯度直方图（ HOG） 是一种在CV常用特征描述子。 通过计算和统计
图像局部区域的梯度方向直方图来构成特征。
- HOG+SVM可以用来做行人检测。

![mark](http://pacdb2bfr.bkt.clouddn.com/blog/image/180812/26DjdmibIi.png?imageslim)


### 一点基础： 图像特征SIFT

SIFT是一种检测局部特征的算法， 该算法通过求一幅图中的特征点及其
有关scale 和 orientation 的描述子得到特征并进行图像特征点匹配。

![mark](http://pacdb2bfr.bkt.clouddn.com/blog/image/180812/i1G5LH4f0A.png?imageslim)

![mark](http://pacdb2bfr.bkt.clouddn.com/blog/image/180812/7lDdmFH6Ah.png?imageslim)


### 一点基础： 图像特征GIST

- GIST通过自然度、 开放度、 粗糙度、 膨胀度、 险峻度对图片进⾏描述 
- MATLAB的实现参见
http://people.csail.mit.edu/torralba/code/spatialenvelope/LMgist.m
- C的版本可参见 http://lear.inrialpes.fr/src/lear_gist-1.2.tgz

![mark](http://pacdb2bfr.bkt.clouddn.com/blog/image/180812/7DaDI62kLC.png?imageslim)

这个 GIST 在电商做图像的同款识别有用过这个feature ，即使有卷积神经网络的各种效果很好的feature 。毕竟它稍微有些耗资源的，有些时候，比如识别同款，用这个feature 基本上差不多了。

GIST 大概是从五个维度对图片做描述。

图像检索习惯用的是神经网络哪一层的特征？视频在回答这个问题的时候被 qq 消音了。



### 一点基础：K最近邻算法（NN=>KNN）

下面图片中只有三种豆，有三个豆是未知的种类，如何判定他们的种类？

=>选择最“近” 的类别作为自己的判定结果

![mark](http://pacdb2bfr.bkt.clouddn.com/blog/image/180814/Hk2e3LLeLj.png?imageslim)


图中绿色的圆点X是什么形状？

=>依据周边最“近” K个点的类别共同判定

![mark](http://pacdb2bfr.bkt.clouddn.com/blog/image/180814/bD1HCiAILL.png?imageslim)



### 一点基础： 距离准则

o  相似度/距离定义

![mark](http://pacdb2bfr.bkt.clouddn.com/blog/image/180814/bk3Em8L5jj.png?imageslim)

欧氏距离 我们习惯上 p=2
Jaccard 相似度 在图像检索中有用到的，


比如我们用 AlexNet 做图像的抽取，把它的 FC 拿出来，是一个 4096*1 的浮点数 vector，这时候我有 500 万个商品，我需要比较 这500万个 vector 与我们搜索的图像的 vector 之间的距离。怎么办呢？

我们可以把 4096 的double 的vecotor 映射成一个 128 bit 的一个数，即一个长度为 128的一个01串，01串之间求相近度的话，你可以使用 Jaccard 相似度，求距离的话也可以用汉明距离。<span style="color:red;">怎么把一个 double 的 vector 映射成一个 128 bit 的一个数的？两个 01 串的相近度和距离有什么区别吗？</span>

所以上面提到的这些距离选择都会有用到的，我们待会看到 Jaccard 或 汉明距离是先把我们的vector 压到一个二进制的x 比特的一个桶里面。<span style="color:red;">怎么压到一个桶里面的？</span>

余弦相似度表征的是高维空间中两个vector 的夹角余弦值。
