# **数据与评价方式**

赛题提供用户在2016年1月1日至2016年6月30日之间真实线上线下消费行为，预测用户在2016年7月领取优惠券后15天以内的使用情况。 使用优惠券核销预测的平均AUC（ROC曲线下面积）作为评价标准。 即对每个优惠券 coupon_id 单独计算核销预测的 AUC 值，再对所有优惠券的 AUC 值求平均作为最终的评价标准。<span style="color:red;">怎么求单独的AUC和平均的AUC？</span>

当测试集中的正负样本的分布变化的时候，ROC曲线能够保持不变。因为在实际的数据集中经常会出现类不平衡，所以次点也是AUC指标的优势。<span style="color:red;">什么是次点？</span>

------

# **解决方案**

提供数据的区间是2016-01-01~2016-06-30，预测七月份用户领券使用情况，即用或者不用，转化为**二分类问题**，然后通过分类算法预测结果。

首先就是特征工程，其中涉及对数据集合的划分，包括提取特征的区间和训练数据区间。
接着就是从特征区间中提取特征，包括用户特征、商户特征、优惠券特征、用户商户组合特征、用户优惠券组合特征。

后期在测试区间提取了当天的前后7/3/1天的领券信息（这里面后七天的特征其实是不能应用于工业应用的，因为实际预测中你无法知道后7/3/1天的领券信息），提升较大。最后使用GBDT、RandomForest、LR进行基于 rank 的分类模型融合。<span style="color:red;">什么叫基于rank 的分类模型融合？</span>




# **数据划分**

最初没有使用数据划分，导致特征中产生数据泄露，以至于在训练数据上效果很好，线下测试也还不错，在线上表现确差强人意，后来划分了之后有明显提升。

| 集合   | 预测区间                                      | 特征区间                                      |
| ------ | --------------------------------------------- | --------------------------------------------- |
| 预测集 | 领券:20160701~20160731                        | 领券 & 消费:20160101~20160630                   |
| 训练集 | 领券:20160515~20160615 消费:20160515~20160630 | 领券:20160101~20160501 消费:20160101~20160515 |

可以划分多个训练集。






# **算法及模型融合**

最初使用RF、[GBDT](http://blog.csdn.net/shine19930820/article/details/65633436)两种模型，[GBDT](http://blog.csdn.net/shine19930820/article/details/65633436)效果优于RF，后期使用了多个[GBDT](http://blog.csdn.net/shine19930820/article/details/65633436)和XGBoost，分别使用不同的参数、不同的正负样本比例以rank的方式进行多模型的融合，效果有微小提升，但是由于计算量的限制没有进一步展开。

## **模型融合**

由于评估指标是计算每个coupon_id核销预测的AUC值，然后所有优惠券的AUC值平均作为最终的评估指标，而rank融合方式对AUC之类的评估指标特别有效，所以采用此方法，公式为：

$$\sum\limits_{i=1}^{n}\frac{Weight_i}{Rank_i}$$

其中$n$表示模型的个数， $Weight_i$表示该模型权重，所有权重相同表示平均融合。RankiRanki表示样本在第i个模型中的升序排名。它可以较快的利用排名融合多个模型之间的差异，而不需要加权融合概率。

## **应用**

基于参数，样本(采样率)，特征获得多个模型，得到每个模型的概率值输出，然后以coupon_id分组，把概率转换为降序排名，这样就获得了每个模型的RankiRanki，然后这里我们使用的是平均融合，Weighti=1/nWeighti=1/n，这样就获得了最终的一个值作为输出。

------

# **线下评估**

虽然这次比赛每天有四次评测机会，但是构建线下评估在早期成绩比较差的时候用处很大，早期添加特征之后线下评估基本和线上的趋势保持一致（例如在添加了Label区间的领券特征之后，线下提升十多个百分点，线上也是一致），对于新特征衡量还是有参照性的。后期差距在0.1%级别的时候，就没有参照性了。

线下评估在训练集中采样1/3 or 1/4 or 1/5做线下评估集合，剩下的做为训练集训练模型，并将评估集合中全0或者全1的优惠券ID去掉，然后使用训练的模型对评估集合预测，将预测结果和实际标签作异或取反（相同为1，不同为0），然后算出每个优惠券ID的AUC，最后将每个ID的优惠券AUC取均值就得到最终的AUC。
