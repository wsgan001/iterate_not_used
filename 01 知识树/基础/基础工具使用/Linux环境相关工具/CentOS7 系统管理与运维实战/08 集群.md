第8蠹 、讓駐*

电子商务已经成为生活中不可缺少的一部分，给用户带来方便和效率。随着计算机硬件的 发展，单台计算机的性能和可靠性越来越髙，网络的飞速发展给网络带宽和服务器带来巨大的 挑战，网络带宽的增长远高于处理器速度和内存访问速度的增长，急剧膨胀的用户请求已经使 单台计算机难以达到用户的需求。为了满足急剧增长的需求，使用集群技术负载均衡迫在眉睫。

本章首先介绍什么是集群技术及集群的体系结构，然后介绍集群软件LVS (Linux Virtual Server)的负载调度算法，并结合各种调度算法给出实际案例。

本章主要涉及的知识点有：

•    Linux集群体系结构

•    LVS负载均衡调度算法

•    LVS负载均衡的安装与设置

![img](11 CentOS7fbdfa1060ed0f49e18-159.jpg)



本章介绍的LVS负载均衡管理主要针对Linux系统下的负载均衡，在WinZws领域软件'

层面尚没有匹配的开源软件支持负载均衡。

8.1集群技术简介

如今互联网应用尤其是Web服务已经越来越广泛。电子商务网站需要提供每天24小时不 间断服务，如发生硬件损坏导致服务中断将造成不可挽回的经济损失。越来越多的网站交互性 不断增强，随着用户量的增长需要更强的CPU和10处理能力。在数据挖掘领域，需要在大 量数据中找出有价值的信息，时间是必须考虑的因素。集群技术的出现顺利解决了这两种问题: 高可用性集群和高性能集群。

集群通过一组相对廉价的设备实现服务的可伸缩性，当服务请求急剧增长时，服务依然可 用，响应依然快速。集群可以允许部分硬件或软件发生故障，通过集群管理软件将故障屏蔽从 而提供24小时不间断的服务。相对于高端服务器的昂贵成本，使用廉价的设备组成集群，所 花费的经济成本相对可以承受。

高可用性集群可以提供负载均衡，通过把任务轮流分给多台服务器完成，以避免某台服务 器负载过高。同时负载均衡是一种动态均衡，可以通过一些工具或软件实时地分析数据包，掌

握网络中的数据流量状况，合理分配任务。

![img](11 CentOS7fbdfa1060ed0f49e18-160.jpg)



比如在数据链路层可以根据数据包的MAC地址选择不同的路径。网络层则可以利用基于 IP地址的分配方式将数据分配到多个节点。对于不同的应用环境，如计算负荷较大的电 子商务网站，IP读写频繁的数据库应用，网络传输量大的视频服务则各自有对应的负载 均衡算法。

3.2 LVS集群介绍

LVS为Linux虚拟服务器(Linux Virtual Server)，针对高可伸缩、高可用网络服务的需求， 中国的章文嵩博士给出了基于IP层和基于内容请求分发的负载平衡调度解决方案，并在Linux 内核实现，将一组服务器构成一个实现可伸缩的、高可用网络服务的虚拟服务器。虚拟服务器 的体系结构如图8.1所示。

图8.1虚拟服务器体系结构



一组服务器通过高速的局域网或地理分布的广域网相互连接，前端有一个负载均衡器 (Load Balancer),有时简称为LD。负载均衡器负责将网络请求调度到真实服务器上，真实的 服务器称作real server,简称rs，从而使得服务器集群的结构对应用是透明的。应用访问集群 系统提供的网络服务就像访问一台高性能、高可用的服务器一样。集群的扩展性可以通过在服 务集群中动态地加入和删除服务器节点完成。通过定期检测节点或服务进程状态可以动态地剔 除故障的节点，从而使系统达到高可用性。

8.2.1    3种负载均衡技术

在LVS框架中，提供了 IP虚拟服务器软件(IPVS)，包含3种IP负载均衡技术，通过此

软件可以快速搭建高可伸缩的、高可用的网络服务，管理也非常方便。 IPVS软件实现了这3种IP负载均衡技术，每种技术原理介绍如下。

\1. Virtual Server via Network Address Translation ( VS/NAT )

此种技术中前端负载均衡器通过重写请求报文的目的地址实现网络地址转换，根据设定的 负载均衡算法将请求分配给后端的真实服务器。真实服务器的响应报文通过负载均衡器时，报 文的源地址被重写，然后返回给客户端，从而完成整个负载调度过程。由于NAT的每次请求 接收和返回都要经过负载均衡器，对前端负载均衡器性能要求较高，如业务请求量较大，负载 均衡器可能成为瓶颈。NAT模式体系结构如图8.2所示。

\2. Virtual Server via IP Tunneling ( VS/TUN )

TUN模式如图8.3所示。采用NAT技术时，由于请求和响应报文都必须经过负载均衡器 地址重写，当客户请求越来越多时，负载均衡器的处理能力可能成为瓶颈。为了解决这个问题， 负载均衡器把请求报文通过IP隧道转发至真实服务器，而真实服务器将响应直接返回给客户， 此种技术负载均衡器只处理请求报文。由于结果不需经过负载均衡器，采用此种技术的集群吞 吐能力也更强大，同时TUN模式可以支持跨网段，并支持跨地域部署，使用非常灵活。

\3. Virtual Server via Direct Routing ( VS/DR )

VS/DR模式如图8.4所示，该模式通过改写请求报文的MAC地址，将请求发送到真实服 务器，类似TUN模式，DR模式下真实服务器将响应直接返回给客户端，因此VS/DR技术可 极大地提高集群系统的伸缩性。这种方法没有IP隧道的开销，真实服务器也没有必须支持IP 隧道协议的要求，但是此种模式要求负载均衡器与真实服务器都在同一物理网段上，由于同一 网段机器数量有限，从而限制了其应用范围。

via Direct Routing

图8.4 LVSDR模式体系结构

8.2.2负载均衡调度算法

针对不同的网络服务需求和服务器配置,IPVS负载均衡器提供了如下几种负载调度算法:

(1)    轮询算法

轮询(Round Robin)算法简称RR,负载均衡器通过轮询调度算法将外部请求按顺序轮流 分配到集群中的真实服务器上，每台后端的服务器都是平等无差别的，此种算法忽略了真实服 务器的负载情况，需结合其他监控手段一起使用=

(2)    加权轮询算法

加权轮询(Weighted Round Robin)算法简称WRR。负载均衡器通过加权轮询调度算法根 据真实服务器的不同处理能力来调度访问请求，从而让处理能力强的服务器处理更多的请求。 负载均衡器可以自动问询真实服务器的负载情况，并动态地调整其权值，相比轮询模式，有更 大的灵活性。

(3)    最少链接算法

最小链接(Least Connections)算法简称LC。负载均衡器通过最少连接调度算法动态地将 网络请求调度到已建立的链接数最少的服务器上。如果集群系统的真实服务器具有相近的系统 性能，采用此种算法可以较好地均衡负载。

(4)    加权最少链接算法

加权最少链接(Weighted Least Connections)算法简称WLC。在集群系统中的服务器性能 差异较大的情况下，负载均衡器采用加权最少链接调度算法优化负载均衡性能，具有较高权值 的服务器将承受较大比例的活动连接负载。

(5)    基于局部性的最少链接算法

基于局部性的最少链接(Locality-Based Least Connections)算法简称LBLC。基于局部性 的最少链接调度算法是针对目标IP地址的负载均衡，该算法根据请求的目标IP地址找出该目 标IP地址最近使用的服务器，如该服务器是可用的且没有超载，将请求发送到该服务器；若 服务器不存在或服务器超载，则用最少链接的原则选出一个可用的服务器，将请求发送到该服 务器，

(6)带复制的基于局部性最少链接算法

带复制的基于局部性最少链接(Locality-Based Least Connections with Replication)算法简 称LBLCR。带复制的基于局部性最少链接调度算法也是针对目标IP地址的负载均衡，与 LBLC算法的不同之处是要维护从一个目标IP地址到一组服务器的映射。该算法根据请求的 目标IP地址找出该目标IP地址对应的服务器组，按最小连接原则从服务器组中选出一台服 务器，若服务器没有超载，将请求发送到该服务器，若服务器超载；则按最小连接原则从这个 集群中选出一台服务器，将该服务器加入到服务器组中，将请求发送到该服务器。

(7)    目标地址散列算法

目标地址散列(Destination Hashing)算法简称DH。此调度算法根据请求的目的IP地址， 作为散列键，从静态分配的散列表找出对应的真实服务器，若该服务器是可用的且未超载，将 请求发送到该服务器，否则返回空。

(8)    源地址散列算法

源地址散列(Source Hashing)算法简称SH。源地址散列调度算法根据请求的源IP地址， 作为散列键从静态分配的散列表找出对应的服务器，若该服务器是可用的且未超载，将请求发 送到该服务器，否则返回空。

8.3 LVS集群的体系结构

LVS集群采用IP负载均衡技术和基于内容请求分发技术。负载均衡器具有很好的吞吐率， 将请求均衡地转移到不同的服务器上执行，且负载均衡器自动屏蔽掉服务器的故障，从而将一 组服务器构成一个高性能的、高可用可伸缩的虚拟服务器。整个服务器集群的结构对客户是透 明的，而且无须修改客户端和服务器端的程序。为此，在设计时需要考虑系统的透明性、可伸 缩性、髙可用性和易管理性。一般来说，LVS集群采用三层结构，其体系结构一般如图8.5 所示。

![img](11 CentOS7fbdfa1060ed0f49e18-165.jpg)



![img](11 CentOS7fbdfa1060ed0f49e18-166.jpg)



服务器2



![img](11 CentOS7fbdfa1060ed0f49e18-168.jpg)



![img](11 CentOS7fbdfa1060ed0f49e18-169.jpg)



![img](11 CentOS7fbdfa1060ed0f49e18-170.jpg)



![img](11 CentOS7fbdfa1060ed0f49e18-171.jpg)



![img](11 CentOS7fbdfa1060ed0f49e18-172.jpg)



图8.5负载均衡通用体系结构

负载均衡集群的通用体系结构一般主要有3个组成部分，分别为：

(1)    负载均衡器(load balancer)简称LD,是整个集群最外面的前端机，上面部署一个 Vip服务，客户请求到达该VIP后LD负责将客户的请求发送到后端的真实服务器上执行，而 客户认为服务是来自一个IP地址上的。

(2)    真实服务器池(real server pool)是一组真正执行客户请求的服务器，负责处理用户 请求并返回结果。

(3)    共享存储(shared storage)是可选组成部分，主要提供一个共享的存储区，从而使 得服务器池拥有相同的内容，提供相同的服务。

LVS负载均衡配置实例

如今Web应用已经非常广泛，本节主要以搭建一组Web服务器并实现LVS的负载均衡为 例，说明LVS负载均衡的配置方法，搭建LVS相关的服务器信息如表8.1所示。

表8.1 LVS实例相关信息

| 参数       | 说明                                |
| ---------- | ----------------------------------- |
| 负载均衡器 | 192.168.32.100、192.168.32.200      |
| 虚拟IP     | 192.168.32.150                      |
| 后端RS     | 192.168.32.1、192.168.32.2          |
| 测试域名   | [www.test.com](http://www.test.com) |

用户访问www.test.com时，会解析到192.168.32.150,然后负载均衡器通过算法将请求转 到后端的真实服务器192.168.32.1或192.168.32.2上面，从而达到负载均衡的目的。

![img](11 CentOS7fbdfa1060ed0f49e18-173.jpg)



在开始所有配置之前，需要确认所有计算机上的LVS模块已加载(模块名为ip_vs)、防 火墙、SELinux等都做了妥善的设置，任何环节设置不合理都会导致整个LVS无法工作。

8.4.1基于NAT模式的LVS的安装与配置

NAT (Network Address Translation)技术的出现有效缓解了 IPv4地址空间不足的问题。 通过重写请求报文的IP地址(目标地址、源地址和端口等)将私有地址转换成合法的IP地址， 从而实现一个局域网只需使用少量IP地址即可实现私有地址网络内所有计算机与互联网的通 信需求。不同IP地址的服务器组也认为其是与客户直接相连的。由此可以用NAT方法将不 同IP地址的并行网络服务变成在一个IP地址上的一个虚拟服务。根据上文提供的服务器信 息介绍基于NAT的Web集群配置。

\1. ipvsadm软件安装

首先应该安装LVS管理工具ipvsadm,本示例中采用的版本为ipvsadm-l.26.tar.gz，安装 过程如【示例8-1】所示。

【示例8-1】

\#解压源码包，在下载源码包时注意内核版本，下载对应的配置工具。 [root@CentOS soft]# tar xvf ipvsadm-1.26.tar.gz

\#可直接编译

[rootOCentOS ipvsadm-1.26]* make #安装

[root@CentOS ipvsadm-1.26]# make install #确认ipvsadm安装成功

[root@CentOS ipvsadm-1.26]#    /sbin/ipvsadm -v

ipvsadm vl.26 2008/5/15 (compiled with popt and IPVS vl.2.1)

安装完毕后主要的程序有3个:

•    /sbin/ipvsadm:为LVS主管理程序，负责RS的添加、删除与修改

•    ipvsadm-save:用户备份LVS配置

•    ipvsadm-restore:用于恢复 LVS 配置

ipvsadm常用参数说明如表8.2所示。

表8.2 ipvsadm常用参数说明

| 参数           | 说明                                                     |
| -------------- | -------------------------------------------------------- |
| -A             | 在内核的虚拟服务器表中添加一条新的虚拟服务器记录         |
| -E             | 编辑内核虚拟服务器表中的一条虚拟服务器记录               |
| -D             | 删除内核虚拟服务器表中的一条虚拟服务器记录               |
| -C             | 清除内核虚拟服务器表中的所有记录                         |
| -R             | 恢复虚拟服务器规则                                       |
| -S             | 保存虚拟服务器规则，输出为-R选项可读的格式               |
| -a             | 在内核虚拟服务器表的一条记录里添加一条新的真实服务器记录 |
| -e             | 编辑一条虚拟服务器记录中的某条真实服务器记录             |
| -d             | 删除一条虚拟服务器记录中的某条真实服务器记录             |
| -L\|-l         | 显示内核虚拟服务器表                                     |
| -Z             | 虚拟服务表计数器清零（清空当前的连接数量等）             |
| •set           | -tcp tcpfin udp设置连接超时值                            |
| --start-daemon | 启动同步守护进程                                         |
| -stop-daemon   | 停止同步守护进程                                         |
| -h             | 显示帮助信息                                             |
| -t             | 说明虚拟服务器提供的是TCP服务                            |
| -u             | 说明虚拟服务器提供的是UDP服务                            |

（续表）

| 参数     | 说明                                                         |
| -------- | ------------------------------------------------------------ |
| -f       | 说明是经过iptables标记过的服务类型                           |
| -S       | 使用的调度算法，常见选项 rr\|wrr\|lc\|wlc\|lblc\|lblcr\|dh\|sh\|sed\|nq |
| -P       | 持久服务                                                     |
| -r       | 真实的服务器                                                 |
| -g       | 指定LVS的工作模式为直接路由模式                              |
| -i       | 指定LVS的工作模式为隧道模式                                  |
| -m       | 指定LVS的工作模式为NAT模式                                   |
| -w       | 真实服务器的权值                                             |
| -c       | 显示LVS目前的连接数                                          |
| -timeout | 显示 tcp tcpfin udp 的 timeout 值                            |
| —daemon  | 显示同步守护进程状态                                         |
| —stats   | 显示统计信息                                                 |
| —rate    | 显示速率信息                                                 |
| —sort    | 对虚拟服务器和真实服务器排序输出                             |
| -n       | 输出IP地址和端口的数字形式                                   |

226

\2. LVS配置

首先在前端负载均衡器192.168.32.100做相关设置，包含设置VIP、添加LVS的虚拟服务 器并添加真实服务器。操作步骤如【示例8-2】所示。

【示例8-2】

\# 户 5^ 由    會 is

[root@LD__192_168_32_100 〜echo "1" >/proc/sys/net/ipv4/ip_forward #清除ipvsadm表

[root@LD 192 168 32 100    # ipvsadm -C

\#使用ipvsadm安装I»VS服务

[root@LD_l92_168_32_100 〜/sbin/ipvsadm -A -t 192,168.32.150:80 #增加第1台realserver

[root@LDJL92_168一32一100 -]# /sbin/ipvsadm -a -t 192.168.32.150:80 -r 192.168.32.r：80~-m ~w 1    /

\#增加第2台realserver

[root@LD一192_168一32J.00 -3# /sbin/ipvsadm -a -t 192.168.32.150:80 .192 • X 6S < 32 • 2 • 80 ro w 1

上述示例首先清除ipvsadm表，然后添加LVS虚拟服务，并指定NAT模式添加真实的服 务器，各个真实服务器权重指定为1,其他参数说明可参考表8.2。

\3. Apache服务搭建

Apache服务需要在真实服务器上部署，部署完毕后需要做一些设置并启动，如【示例8-3】 所示。

【示例8-3]

[root@RS 192 168 32 1 soft]# tar xvf httpd-2.2.17.tar.gz

[roo 靡 SJL92J68 一 32_1 soft]# cd httpd-2.2.17

[root@RS一192一168一32」httpd-2.2.17]# ./configure --prefix=/usr/local/apaehe2 [root@RS 192 168 32 1 httpd-2.2.17]# make

[root@RS_192_168_32__l httpd-2.2.17}# make install    ,

\#编辑配置;件S改对&行并保存

[root@RS_192_168_32_1 httpd-2.2.17]# vim /usr/local/apache2/conf/httpd.conf Listen 0.0.0.0:80

[root@RS一192_168一32 echo welcome to 192 #启动服务

[root@RS_192_168_32

start

\#测试服务

[root@RS 192 168 32



1 httpd-2.2.17]#cat /usr/local/apache2/htdocs/index.html

168.32.1

1 httpd-2.2.17]# /usr/local/apache2/bin/apachectl -k

1 httpd-2.2.17]# curl <http://192.168.32>.!

welcome to 192.168.32.1

另外一个节点192.168.32.2做类似设置，不同之处在于首页内容为“welcome to 192.168.32.2”，其他情况相同。

4.真实服务器设置

如需LVS代理到后端的真实服务器，后端真实服务器需要启动服务，并确认服务端口监 听在0.0.0.0或VIP上，然后设置真实服务器的VIP，设置VIP的网络接口可以选择ethO或tunlO。 步骤如【示例8-4】所示。

【示例8-4】

[root@CentOS # cat -n tun.sh

1    #设置IP转发

2    echo ”0n >/proc/sys/net/ipv4/ip一forward

3    #设置VIP

4    /sbin/ifconfig tun10 up

5    /sbin/ifconfig tunlO 192.168.32.150 broadcast 192.168.32.150 netmask 255.255.255.255 up

6    #避免arp广播问题

7    echo 1 > Zproc/sys/net/ipv4/conf/tunl0/arp__ignore

8    echo 2 > /proc/sys/net/ipv4/conf/tunl0/arp__announce

9    echo 1 > /proc/sys/net/ipv4/conf/all/arp_ignore

10    echo 2 > /proc/sys/net/ipv4/conf/all/arp__announce

\#设置路由

[root@CentOS /sbin/route add -host 192.168.32.150 dev tunlO

\#检査相关设置

[root@CentOS 〜ifconfig tunlO

tunlO Link encap:IPIP Tunnel HWaddr

inet addr:192.168.32.150 Mask:255.255.255.255 UP RUNNING NOARP MTU:1480 Metric:!

RX packets:0 errors:0 dropped:0 overruns:0 frame:0 TX packets:0 errors:0 dropped:0 overruns:0 carrier:0 collisions:0 txqueuelen:0

\*    RX bytes:0 (0.0 b) TX bytes:0 (0.0 b)

当客户端访问VIP时，会产生arp广播，由于前端负载均衡器LD和Apache真实的服务 器RS都设置了 VIP，此时集群内的真实服务器会尝试回答来自客户端的请求，从而导致多台 机器响应自己是VIP，因此为了达到负载均衡的目的，需让真实服务器忽略来自客户端计算机 的arp广播请求。

\5. LVS测试

确认真实后端服务器已经启动并监听在0.0.0.0,并且真实服务器上设置了 VIP, LVS前端 负载均衡器已经添加了虚拟服务，然后进行LVS的测试，测试过程如【示例8-5】所示=

【示例8-5】

[root@LD_192_168_32_100 -]# curl <http://192.168.32.150> welcome to 192.168.32.1

[root@LD_192_168_32_100 -]# curl <http://192.168.32.150> welcome to 192.168.32.2 [root@LD一192_168一32一100 -]#

使用命令行测试，从上面的结果可以看出，LVS服务器己经成功运行。

8.4.2基于DR模式的LVS的安装与配置

在VS/NAT的集群系统中，请求和响应的数据报文都需要通过负载均衡器，当真实服务 器的数目在10台和20台之间时，如请求量不高，则运行良好，如请求量突增或响应报文包含 大量的数据，负载均衡器将成为整个集群系统的瓶颈。VS/DR利用大多数Internet服务的非 对称特点，负载均衡器中只负责调度请求，而服务器直接将响应返回给客户，可以极大地提高 整个集群系统的吞吐量。

l.ipvsadm软件安装

首先可以按上节提供的方法安装ipvsadm软件。

\2. LVS配置

首先在前端负载均衡器192.168.32.100做相关设置，包含设置VIP，并添加LVS的虚拟服 务器并添加真实服务器。操作步骤如【示例8-6】所示。

【示例8-6]



\#启用路由转发功能 [root@LDJL92一 168一32_100 〜]# #清除ipvsadm表

[root⑽一 192一 168一32一 100 -]# #使用ipvsadm安装LVS服务 [root@LD_192_168_32_100 -]# #增加第1台realserver [root@LD_192_168_32__100 〜]#

192.168.32.1:80 -g -w 1 #增加第2台realserver troot@LD__192_168_32_100 -]#

192.168.32.2:80 -g -w 1



echo "1" >/proc/sys/net/ipv4/ip_forward

ipvsadm -C

0

/sbin/ipvsadm -A -t 192.168.32.150:80

/sbin/ipvsadm ~a -t 192.168.32.150:80 -r

/sbin/ipvsadm -a 192.168.32.150:80 -r：

上述示例首先清除ipvsadm表，然后添加LVS虚拟服务，并指定用直接路由DR模式添 加真实的服务器，各个真实服务器权重指定为1,其他参数说明可参考表8.2。

\3. Apache服务搭建

Apache服务需要在真实服务器上部署，部署完毕后需要做一些设置并启动，可以按上节 的方法安装和部署。

4.真实服务器设置

如需LVS代理到后端的真实服务器，后端真实服务器需要启动服务，并确认服务端口监 听在0.0.0.0或VIP上，然后设置真实服务器的VIP。设置VIP的网络接口可以选择ethO或tunlO。 步骤如【示例8-7】所示。

【示例8-7】

[root@CentOS # cat -n tun.sh

1    #设置IP转发

2    echo ”0" 〉/proc/sys/net/ipv4/ip一forward

3    #设置VIP

4    /sbin/ifconfig tunlO up

5    /sbin/ifconfig tunlO 192.168.32.150 broadcast 192.168.32.150 netmask 255.255.255.255 up

6    #避免arp广播问题

7    echo 1 > /proc/sys/net/ipv4/conf/tunlO/arp_ignore

8    echo 2 > /proc/sys/net/ipv4/conf/tunlO/arp__announce

9    echo 1 > /proc/sys/net/ipv4/conf/all/arp_ignore



![img](11 CentOS7fbdfa1060ed0f49e18-174.jpg)



10 echo



并设置路由



2 > /proc/sys/net/ipv4/conf/all/arp_announce



[root@CentOS 〜]# /sbin/route add -host 192.168.32.150 dev tunlO



![img](11 CentOS7fbdfa1060ed0f49e18-175.jpg)



\#检査相关设置

[rootGCentOS # ifconfig tunlO



tunlO Link encap:IPIP Tunnel HWaddr

inet addr:192.168.32.150 Mask:255.255.255.255



![img](11 CentOS7fbdfa1060ed0f49e18-176.jpg)



UP RUNNING NOARP MTU：1480 Metric：!

RX packets:0 errors:0 dropped:0 overruns:0 frame:0 TX packets:0 errors:0 dropped:0 overruns:0 carrier:0 collisions:0 txqueuelen:0

RX bytes:0 (0.0 b) TX bytes:0 (0.0 b)

当客户端访问VIP时，会产生arp广播，由于前端负载均衡器LD和Apache真实的服务 器RS都设置了 VIP，此时集群内的真实服务器会尝试回答来自客户端的请求，从而导致多台 机器响应自己是VIP，因此为了达到负载均衡的目的，需让真实服务器忽略来自客户端计算机 的arp广播请求。

\5. LVS测试

确认真实后端服务器已经启动并监听在0.0.0.0,并且真实服务器上设置了 VIP, LVS前端 负载均衡器已经添加了虚拟服务，然后进行LVS的测试，测试过程如【示例8-8】所示。

【示例8-8】

[root@LD_192_168_32_100 -]# curl <http://192.168.32.150> welcome to 192,168.32.1

[root@LD_192_168_32_100 -]# curl <http://192.168.32.150> welcome to 192.168.32.2

使用浏览器或命令行测试，从上面的结果可以看出，LVS服务器已经成功运行。

VS/DR的工作流程如图8.6所示，负载均衡器根据各个服务器的负载情况，动态地选择一

台服务器，将数据帧的MAC地址改为选出服务器的MAC地址，再将修改后的数据帧在服务 器组的局域网上发送。因为数据帧的MAC地址是选出的服务器，所以服务器肯定可以收到这 个数据帧，从中可以获得该IP报文。当服务器发现报文的目标地址VIP是在本地的网络设备 上，服务器处理这个报文，然后根据路由表将响应报文直接返回给客户。

IP数据包



| VIP  |      |
| ---- | ---- |
|      |      |



![img](11 CentOS7fbdfa1060ed0f49e18-177.jpg)



![img](11 CentOS7fbdfa1060ed0f49e18-178.jpg)



| SrvMAC |      | VIP  |      |      |
| ------ | ---- | ---- | ---- | ---- |
|        |      |      |      |      |

VIP



调度器选择一个服务器

然后格数据包直接转发给真实服务

器



:真实服务器在收到数据包后，查看数 :据包的目的地址（VIP），发现是给 :自己的数裾包，立即将数据交给上层 :服处理，然后以VIP为趣地址给客户 :疎返回应答.



图8.6 LVSDR报文流程

8.4.3基于IP隧道模式的LVS的安装与配置

IP隧道(IP tunneling)是将一个IP报文封装在另一个IP报文的技术，这可以使得目标 为一个IP地址的数据报文能被封装和转发到另一个IP地址。IP隧道技术亦称为IP封装技 术(IP encapsulation)。IP隧道主要用于移动主机和虚拟私有网络(Virtual Private Network)， 在其中隧道都是静态建立的，隧道一端有一个IP地址，另一端也有唯一的IP地址。

\1.    ipvsadm软件安装

首先可以按上节提供的方法安装ipvsadm软件。

\2.    LVS配置

首先在前端负载均衡器192.168.32.100做相关设置，包含设置VIP,并添加LVS的虚拟服 务器并添加真实服务器。操作步骤如【示例8-9】所示。

【示例8-9】

\#启用路由转发功能 [root@LD_JL92一 168一32一 100 -]# #清除ipvsadm表

[root⑽一 192_168_32」00 -]# #使用ipvsadm安装LVS服务 [root@LD_192_168_32_100    #

\#增加第1台realserver [root⑽一 192一 168一32一 100 -]# 192.168.32.1:80 -i -w 1 #增加第2台realserver [root@LD」92一 168一32一 100 -]# 192.168.32.2:80 -i-w 1



![img](11 CentOS7fbdfa1060ed0f49e18-179.jpg)



echo ”1" >/proc/sys/net/ipv4/ip一forward

ipvsadm -C

/sbin/ipvsadm -A -t 192.168.32.150:80

/sbin/ipvsadm -a -t 192.168,32.150:80 -r

/shin/ipvsadm -a    192.168.32.150:80 -r

上述示例首先清除ipvsadm表，然后添加LVS虚拟服务，并指定IP隧道模式添加真实的 服务器，各个真实服务器权重指定为1，其他参数说明可参考表8.2。

\3.    Apache服务搭建

Apache服务需要在真实服务器上部署，部署完毕后需要做一些设置并启动，可以按上节 的方法安装和部署。

\4.    真实服务器设置

如需LVS代理到后端的真实服务器，后端真实服务器需要启动服务，并确认服务端口监 听在0.0.0.0或VIP上，然后设置真实服务器的VIP。设置VIP的网络接口可以选择ethO或tunlO。 步骤如【示例8-10】所示。

【示例8-10】

[root@CentOS 〜]林 cat -n tun.sh

1    #设置IP转发

2    echo "0" >/proc/sys/net/ipv4/ip_forward

3    #设置VIP

4    /sbin/ifconfig tunlO up

5    /sbin/ifconfig tunlO 192.168.32,150 broadcast 192.168.32.150 netmask 255.255.255.255 up

6    #避免arp广播问题

7    echo 1 > /proc/sys/net/ipv4/conf/tunlO/arp_ignore

8    echo 2 > /proc/sys/net/ipv4/conf/tunlO/arp_announce

9    echo 1 > /proc/sys/net/ipv4/conf/all/arp_ignore

10    echo 2 > /proc/sys/net/ipv4/conf/all/arp_announce

\#设置路由    ~

[root@CentOS -]# /sbin/route add -host 192.168.32.150 dev tunlO #检查相关设置

[root@CentOS # ifconfig tunlO tunlO Link encap:IPIP Tunnel HWaddr

inet addr:192.168.32.150 Mask:255.255.255.255

UP RUNNING NOARP MTU:1480 Metric:1

RX packets:0 errors:0 dropped:0 overruns:0 frame:0

TX packets:0 errors:0 dropped:0 overruns:0 carrier:0

collisions:0 txqueuelen:0

RX bytes:0 (0.0 b) TX bytes:0 (0.0 b)

当客户端访问VIP时，会产生arp广播，由于前端负载均衡器LD和Apache真实的服务 器RS都设置了 VIP,此时集群内的真实服务器会尝试回答来自客户端的请求，从而导致多台 机器响应自己是VIP,因此为了达到负载均衡的目的，需让真实服务器忽略来自客户端计算机 的arp广播请求。

\5. LVS测试

确认真实后端服务器已经启动并监听在0.0.0.0,并且真实服务器上设置了 VIP, LVS前端 负载均衡器已经添加了虚拟服务，然后进行LVS的测试，测试过程如【示例8-11】所示。

【示例8-11】

[rootSLD_192_168_32_100 ~]# curl <http://192.168.32.150> welcome to 192.168.32.1

[root@LD_192_168_32_100 -J# curl <http://192.168.32.150> welcome to 192.168.32.2

使用浏览器或命令行测试，从上面的结果可以看出，LVS服务器已经成功运行。

VS/TUN的工作流程如图8.7所示：负载均衡器根据各个服务器的负载情况，动态地选择

一台服务器，将请求报文封装在另一个IP报文中，再将封装后的IP报文转发给选出的服务器;

服务器收到报文后，先将报文解封获得原来目标地址为VIP的报文，服务器发现VIP地址被 配置在本地的IP隧道设备上，所以就处理这个请求，然后根据路由表将响应报文直接返回给 客户。

![img](11 CentOS7fbdfa1060ed0f49e18-180.jpg)



凋度器收到数据包后，选择一 个服务器，使用该服勞器的ip 地址（dip）作为目的地址对 数据包进行封装.

具实服务收到数据包后解开数 据包，发现是发给自己的包，于 是将数据交给上层应用程序处 理，完成后将数据直接返回给 用户.

图8.7 LVS TUN模式报文流程

■    利用集群搭建高可用MySQL平台

本节主要以高可用MySQL平台为例介绍负载均衡软件LVS和高可用软件HA在MySQL 方面的应用。

8.5.1高可用MySQL平台的功能

随着MySQL实例的增长，统一的监控系统是必要的，有效及时的监控告警可以保证及时 发现系统中的问题，如主从同步状态、实例吞吐量、使用空间、慢查询数量、数据平均访问延 迟等都需要及时了解，结合Web化的管理系统是一个有效手段。为避免一些危险操作导致数 据丢失或恶意篡改，在热备的基础上定期冷备是必要的，以便在突发情况下恢复数据，同时冷 备数据的恢复需要做定期演练以便确认冷备有效和恢复流程。

当MySQL实例增多时，需要有效的权限管理，MySQL权限管理一般基于用户名和主机 名，可按需分配增删改查或更高级的权限，当MySQL实例增至上百或上千的规模，日常权限 的管理和审计需要有流程化的运维工具支撑，同时DROP、ALTER等高级权限应该避免分配 给开发使用。

由于实例的增长，需要支撑的应用越来越多，如何避免应用开发者的SQL拖垮MySQL 服务或耗时增加，SQL审核尤其是数据库变更需要制定规范和流程保证。尽管有了 SQL审核， 但不可避免地存在数据库慢查询，开启慢查询日志是必要的，同时需要对慢查询日志做按天的 审计，通过此方法可以及时发现系统中的异常SQL，以便及时优化。

由于实例的增长，服务器故障的可能性增加，如何在故障的情况下实现应用的快速切换是

必须考虑的问题，一种是通知应用层切换，此种方法成本较高而且耗时较长，另外一种是屏蔽 MySQL实例的细节，由MySQL存储层完成切换，以便及时完成故障切换。同时由于访问量 急剧增长，完善的扩容和数据迁移工具是需要考虑的。

综上所述，完善的高可用MySQL平台应该包含以下功能：

(1)    有效的监控

(2)    完善的容灾及故障切换

(3)    SQL审核，慢查询审计

(4)    有效的权限管理

(5)    权限管理与审计

(6)    Web化的管理系统

(7)    扩容、迁移自动化

基于以上需求，建设髙可用MySQL平台是必要的，限于篇幅本章主要介绍容灾方面的可 选方案。

8.5.2可选方案对比

目前开源社区有很多优秀的代理方案，如HAProxy、MySQL Proxy和域名等，每种方案 各有优缺点，在不同的场合可以使用不同的代理方案，本节主要对比这几种方案的优缺点。

\1. HAProxy

HAProxy提供高可用性、负载均衡以及基于TCP和HTTP应用的代理，支持虚拟主机， 是一种免费、快速并且可靠的解决方案。HAProxy比较适用于那些负载特大的Web站点，同 样可以代理MySQL等服务，HAProxy可以支持数以万计的并发连接，并且它可以很简单地整 合进你当前的业务架构中，HAProxy可以使Web服务器不被暴露到公网上=

MySQL主要使用了权限管理失效代理，MySQL的权限管理基于用户名和主机名，由于 是应用层代理，需要对HAProxy的主机分配权限，这样任何知道用户名密码的用户都可以连 接该MySQL示例，对于数据安全造成比较大的隐:患。结合iptables防火墙可以缓解此问题。

\2. MySQL Proxy

MySQL Proxy是一个处于客户端和MySQL服务端之间的代理程序，可以监测、分析或改 变客户端与服务器端的通信。使用灵活，没有限制，并且可以实现负载平衡、查询分析、查询 过滤和修改等功能=MySQL Proxy为一个连接池，负责将开发者应用层的连接请求转发给数 据库，并且可以通过使用Lua脚本实现复杂的连接控制和过滤，从而实现读写分离和负载平 衡。对于开发者来说是完全透明的，应用则只需要连接到MySQLProxy的监听端口即可。

当然，这样Proxy机器可能成为单点失效，但完全可以使用多个Proxy机器作为兀余，开

发者应用负责故障时的切换。MySQL Proxy可以实现读写分离，基本原理是让主数据库处理 事务性查询，让从库处理查询。数据库复制被用来把事务性查询导致的变更同步到集群中的从 库。其最新版本可以在 [http://dev.mysql.com/downloads/mysql-Proxy/](http://dev.mysql.com/downloads/mysql-Proxy/%e8%8e%b7%e5%8f%96%e3%80%82)[获取。](http://dev.mysql.com/downloads/mysql-Proxy/%e8%8e%b7%e5%8f%96%e3%80%82)

3.域名

域名方式类似本机配置hosts的方式，在出现故障时通过更改域名指向可以快速将开发者 应用切换到其他的MySQL服务器，此方案需要维护一套DNS系统，増加了维护成本，同时 DNS服务需要主备部署以便应对突发情况。

\4. hosts 配置WS

本方法可以在主机上配置一系列的hosts,通过批量管理工具如puppet可以实现hosts文 件的统一配置管理，通过相关程序实现自动监控和hosts的自动修改，可以作为一种可选的解 决问题的方法。需要注意的是切换后要注意MySQL长链接的切换。

8.5.3高可用MySQL平台实现方案

上节介绍了目前儿种优秀的MySQL代理方案，如HAProxy、MySQL Proxy和域名等，每 种方案各有优缺点，在不同的场合可以使用不同的代理方案，本项目实现的方案为： LVS+HA+PORT+iptables,其中 iptables 是可选的步骤。

LVS集群采用IP负载均衡技术和基于内容请求分发技术。调度器具有很好的吞吐率，将 请求均衡地转移到不同的服务器上执行，且调度器自动屏蔽掉服务器的故障，从而将一组服务 器构成一个高性能的、高可用的虚拟服务器集群。整个服务器集群的结构对客户是透明的，而 且无须修改客户端和服务器端的程序。在MySQL代理方面有不俗的表现，不失为一种优秀的 代理方案。

本方案中LVS主要解决负载均衡和调度管理，HA负责前端代理服务的高可用，在成百上 千的MySQL应用中采用端口区分不同的应用，iptables实现权限的控制与异常请求来源处理。

8.5.4搭建MySQL集群

MySQL集群涉及的资源信息如表8.3所示。

表8.3 MySQL集群资源信息说明

| 参数           | 说明                                                         |
| -------------- | ------------------------------------------------------------ |
| my.cnf         | MySQL实例启动时需要的配置文件模板                            |
| mysql.conf     | MySQL实例配置文件模板需要的参数设置，每行表示一个实例需要的参数 |
| genlnstance.sh | 根据mysql.conf和my.cnf生成每个实例需要的配置文件并启动对应实例，分配 对应的管理账户 |
| rep. conf      | MySQL实例主从配置，每行代表一对主从配置                      |
| rep.sh         | 根据rep.conf自动给对应的从库分配热备需要的用户名和密码       |

（续表）

| 参数          | 说明                                                      |
| ------------- | --------------------------------------------------------- |
| rebei.conf    | MySQL实例主从配置，与rep.conf配置文件对应                 |
| rebei.sh      | 根据rebei.conf读取主数据库的binglog位置并自动搭建主从关系 |
| 192.168.3.200 | 这台机器可以登录所有MySQL实例，以便进行日常管理           |
| 192.168.3.100 | 部署MySQL实例                                             |
| 192.168.3.101 | 部署MySQL实例                                             |
| 192.168.3.102 | 部署MySQL实例                                             |
| 192.168.3.103 | 部署MySQL实例                                             |

如MySQL实例较多，端口分配需要遵守一定的规则，本方案统一采用5位端口号，单个 VIP理论上可以容纳5万多个端口应用10000-65535，可以满足绝大多数应用场景。其中第1 位表示是主数据库还是从数据库，1表示主数据库，2表示是主数据库的第1级从库，3表示 连接在第1级从库后面的从库，其他数值依次类推。后面两位用于标识每个开发者应用，最后 两位表示每个应用对应的MySQL实例编号，如01表示该应用的第1个数据库，如应用分库 分表，则直接可以向上累加，一直到99。为便于演示，本节主要搭建两对MySQL主从实例， 其基本信息如【示例8-12】所示。

【示例8-12】

主主



192.168.3.100 10101 从192.168.3.101 20101

192.168.3.102 10201 从192.168.3.103 20201:

本节需要的实例对采用脚本完成，不同的MySQL实例使用相同的MySQL配置文件模 板，模板中设定了一些有关每个MySQL实例个性化的设置，然后通过主执行脚本读取该配置 文件，然后完成MySQL实例的配置。

\1. MySQL 安装

MySQL的安装可以采用源码或rpm包安装，具体的安装过程可以参考第6章有关内容， 本节主要采用源码安装的方法，如【示例8-13】所示。

【示例8-13]

[root@CentOS soft]# tar xvf mysql-5.X.49.tar.gz [rootQCentOS soft}# useradd mysql [rootGCentOS soft]# groupadd mysql [rootSCentOS soft]# cd mysql-5.1.49

[root@CentOS mysql-5.1.49]# ./configure --prefix=/usr/local/mysql/

--enable-local-infile --with-extra-charsets=all --with-plugins=innobase

\#编译

[root@CentOS mysql-5.1.49]#make

本示例中的MySQL配置文件模板主要说明MySQL配置文件模板的代表性的几个参数， 更多配置参数含义可参考MySQL帮助文档。MySQL实例配置文件模板主要参数内容如【示 例8-14】所示。

【示例8-14】

[root@CentOS # cat ~n my.cnf

1    # The MySQL server

2    [mysqld]

3    #MySQL实例启动后绑定的IP,因为需要LVS接入，需要绑定到0.0.0.0或VIP

4    bind-address    =    0.0.0.0

5    #MySQL实例的端口

6    port    =    PORT

7    #MySQL实例本地socket登录文件路径

8    socket    =    PATH/mysql.sock

9    #MySQL实例数据文件所在位置

10    datadir    - PATH

11    #SQL执行时需要产生的临时文件位置

12    mpdir    = PATH

13    #用户标识唯一一个实例的server-id,在设置主从同步时需要

14    server-id    =    SERVER!D

15    #MySQL 实例 binlog 位置

16    log-bin~BINLOG/mysql-bin

17    #MySQL 实例 irmodb 路径及 innodb_buf fer_pool_size 大小设置

18    innodb 一 data—home 一 dir =    PATH

19    innodto 一 log一 group 一home 一 dir    =    PATH

20    innodb__buf fer_pool_size = SIZEG

上述示例中主要参数有MySQL实例启动时绑定的IP,可以使用0.0.0.0或VIP,本节采 用的LVS 3种模式中的TUN模式，依据其原理，当请求包到达MySQL实例所在的网络接口 时，由于数据包的目的IP是VIP和端口，如果MySQL服务器绑定本机IP或127.0.0.1，数据 包将会被丢弃，从而客户端不能连接MySQL服务器。

与MySQL配置文件模板对应的为参数设置文件mysql.conf,每行对应一个实例需要传入 模板文件的参数，如【示例8-15】所示。

【示例8-15】

[root@CentOS -]# cat mysql.conf



\#IP

192.168.3.100

192.168.3.101

192.168.3.102

192.168.3.103



datadir



binlogdir    port



/data/dbdatal0101 /data/dbdata20101 /data/dbdata10201 /data/dbdata20201



/data/binloglG101 10101 /data/binlog20101 20101 /data/binlogl0201 10201 /data/binlog20201 20201



innodb_buffer_pool_size

1

1

1

1



需要设置的代表性的参数有:

•    数据库数据目录datadir,主要存放MySQL实例的数据文件、日志等。

•    二进制文件binlog的目录，binlog是部署数据库主从服务器必须的文件。

•    MySQL实例启动后监听的端口。

•    每个MySQL实例需要innodb缓存参数innodb_buffer_pool_size, MySQL实例默认采 用innodb引擎。

genlnstance.sh脚本的主要功能是读取MySQL配置文件模板my.cnf和参数设置文件 mysqLconf,通过一定的设置后启动相对应的MySQL示例。启动完毕后分配相关的用户名和 密码，分配的管理账户用户名为“admin”，密码为“admin”，客户端IP为192.168.3.200。 脚本内容如【示例8-16】所示。

【示例8-16】

| [rootQCentOS 〜]# cat -n genlnstance.sh1    #!/bin/sho |                                                              |               |
| ------------------------------------------------------ | ------------------------------------------------------------ | ------------- |
| 3 function LOG()                                       | ago")”" "$1"                                                 |               |
| •i56                                                   | echo "["$(/bin/date    -d "0 days}                           |               |
| 78910                                                  | function setENV()                                            |               |
| fexport PATH=/usr/local/mysql/bin:$PATH:.              |                                                              |               |
| 11                                                     | export LOCAL一/sbin/ifconfig \|grep -al ethO Igrep inet Iawk |               |
| '{print $2}’ {awk -F    ' {print $2}' I head -1'       |                                                              |               |
| 12                                                     | I                                                            |               |
| 13                                                     |                                                              |               |
| 14                                                     |                                                              |               |
| 15                                                     | function process()                                           |               |
| 16                                                     | {                                                            |               |
| 17                                                     | cat mysql.conf 1awk -*{if(LOCAL—                             | IP=-$1) print |
| $0}1>/tmp/                                             | .mysql.conf                                                  |               |
| 18                                                     | while read ip path binlog port size                          |               |
| 19                                                     | do                                                           |               |
| 20                                                     | LOG ==$ip==$path==$binlog==$port                             |               |
| 21                                                     | if [ "$ip” ！二"n ~a "$path"    一a "$binlog"    ”           | "-a n$portH   |
| -a "$size"                                             |                                                              |               |
| 22                                                     | then                                                         | 资忽談知嫁餐  |
| 23                                                     | mysqladmin --defaults-file=/etc/$port/my.cnf                 | -u root       |
| shutdown                                               |                                                              |               |
| 24                                                     | LOG "mkdir $pathn                                            |               |
| 25                                                     | mkdir -p $path                                               |               |
| 26                                                     | chmod -R a+r $path $binlog                                   |               |
| 27                                                     | LOG "mkdir $binlogH                                          |               |
| 28                                                     | mkdir -p $binlog                                             |               |
| ■    29                                                | chown -R mysql .mysql $path $binlog    •人’7 ,               |               |

| 30                                                           | find $path $binlog -type d\|xargs chmod a+x                  |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| 31                                                           | find $path $binlog -type fIxargs chmod a+r                   |
| 32                                                           | ID«'date +%s'                                                |
| 33                                                           | LOG path«$path                                               |
| 34                                                           | LOG binlog=$binlog                                           |
| 35                                                           | mkdir -p /etc/$port                                          |
| 36                                                           | LOG SERVER一IID                                              |
| 37                                                           |                                                              |
| 38                                                           | cat my.cnflsed n s \| I«OCAL_I P \| $ ip {gn | sed us I PATH I $path} gM { sed |
| ”s \| BINLOG 1 $binlog | g"丨 sed ns| PORT} $port 丨 g•，丨 sed "s 丨 SERVERID \|$ID\|gH\| sed |                                                              |
| "sjSIZEi$size{g" >/etc/$port/my.cnf                          |                                                              |
| 39                                                           | mysql__install__db --defaults-file=/etc/$port/my.cnf         |
| ——user=mysql                                                 |                                                              |
| 40                                                           | mysqld_safe '■-defaults~f ile=/etc/$port/my. cnf --user-mysql & |
| 41                                                           | .    sleep 30                                                |
| 42                                                           | echo "GRANT ALL ON .* TO * admin1@1192.168.3.2001 IDENTIFIED |
| BY * admin•                                                  | WTTH GRANT OPTION; n\|mysql ~u root -S $path/mysql.sock      |
| 43                                                           | echo "show databasesH J mysql -u root ~S $path/mysql.sock    |
| 44                                                           | echo "select host,user from mysql.usern\|mysql -u root 一S   |
| $path/mysql.sock                                             |                                                              |
| 45                                                           | Is -lhtr $path                                               |
| 46                                                           | sleep 2                                                      |
| 47                                                           | netstat -pint                                                |
| 48                                                           | fx                                                           |
| 49                                                           | done</tmp/.mysql.conf                                        |
| 50                                                           |                                                              |
| 51                                                           | }                                                            |
| 52                                                           |                                                              |
| 53                                                           |                                                              |
| 54                                                           | function main()                                              |
| 55                                                           | {                                                            |
| 56                                                           | setENV                                                       |
| 57                                                           | process                                                      |
| 58                                                           | } 霸…'，    :誦                                              |
| 59                                                           |                                                              |
| 60                                                           | LOG "genlnstance start”                                      |
| 61                                                           | main                                                         |
| 62                                                           |                                                              |

上述脚本主要包含3个函数：

•    main为主函数，通过调用其他函数完成脚本实现的功能。

•    setENV函数主要用于设置脚本需要的环境变量，如文件搜索路径PATH，获取本机 BP等。

•    process函数首先读取参数配置文件mysql.conf，通过对比IP找出需要在本机启动的 MySQL实例配置。然后依次读取每行参数，创建需要的数据目录datadir，binlog目 录，替换my.cnf中的参数生成每个实例需要的配置文件，配置文件位于/etc目录下。

第39行功能为初始化MySQL实例需要的系统表，第40行为启动MySQL实例并放入后 台执行。由于MySQL实例启动需要一定时间，通过sleep 30秒等待实例启动完成，通过本地 socket方式登录MySQL并分配用户管理的用户名密码192.168.3.200是用于管理所有MySQL 实例的主机。

经过以上步骤完成了 MySQL单个实例的部署，接下来进行MySQL热备环境的部署。热 备环境的部署主要经过两步：

(1)    主MySQL实例给从MySQL分配热备需要的用户名和密码。

(2)    由于MySQL实例是新部署的，没有应用数据，因此从数据库可以直接获取主MySQL 的binglog位置，然后通过指定的命令连接到主MySQL实例。

2.从库通过"start slave"启动MySQL热备并检查

各个实例之间的主从关系如【示例8-17】所示。

【示例8-17]

[root@CentOS # cat rep.conf

192.168.3.100 10101 192.168.3.101 20101

192.168.3.102 10201 192.168.3.103 20201

上述配置文件每一行四列，每行表示一对MySQL主从关系设置。前两列表示主MySQL 实例的服务器IP和端口，后两列表示从数据库的服务器IP和端口。

rep.sh功能为读取rep.conf的配置，然后在MySQL主服务器上分配从数据库搭建热备时 需要的用户名和密码，用户名为“rep”，密码为空。脚本源码如【示例8-18】所示。

【示例8-18】

[root@CentOS # cat ~n rep.sh

1    #!/bin/sh

2

3    function LOG()

13

14

15    function process{)

16 {

17    cat rep.conf|awk -vLOCAL IP=$LOCAL IP *{if(LOCAL IP==$1) prints $0} '>/tinp/. rep. conf

18    while read mip mport sip sport

19    do

20

"$sport” ！《 ""] ， 21

22

23

CLIENT,SUPER ON

24

25

26 • 27

28



if [ "$mip" ""一a n$mportM !二”"-a "$sip" != "" ~a

then

LOG ~$mip~=$mport~$sip=~ $ sport

sql-»flush logs;GRANT FILE,REPLICATION SLAVE,REPLICATION TO rep@”$sip"工 DENTIFIED by n flush privileges; *

LOG n$sqlM

mysql_cmci=nmysql ~u root ~S /data/dbdata$mport/mysql. sock*' LOG °$mysql_cmdn echo $sql |$mysql_cmd

29

30 3r

32

33

34

35

36

37

38

39

40



done</tmp/.rep,conf

function main()    :Q?

{

setENV

process

}

LOG "grant rep start” main

LOG ”grant rep end”

此脚本在MySQL主实例在的机器上运行，运行成功后会自动分配从数据库搭建热备需要 的用户名和密码。

完成热备需要的用户名密码后，接下来进行热备关系的搭建，热备关系的搭建也是通过脚 本完成。

rebei.conf配置类似于rep.conf，不同的是前两列是从库的服务器IP和端口，后两列为主 服务器的服务器IP和端口。配置文件如【示例8-19】所示。

【示例8-19】

[root@CentOS 〜]眷 cat rebei.conf

192.168.3.101 10101 192.168.3.100 20101

192.168.3.103 10201 192.168.3.102 20201

rebei.sh功能为读取rebei.conf的配置，然后在MySQL从服务器上得到主服务器当前的 binlog文件名和位置，然后通过“change master”命令设置主从关系，设置成功后使用“start slave”开启热备。脚本源码如【示例8-20】所示。

【示例8-20】

[root@CentOS # cat -n rebei.sh

1    #!/bin/sh

2

3    function LOG()

4    {

5    echo n[n$(/bin/date    -d w0 days ago")np "$1"

a 1 v j

8    function setENV()

17    cat rebei. conf lawk - vLOCAL XP=^$LOCAL IP * {if (LOCAL XP-«$1) print $0}1>/tmp/.rebei.conf

18    while read sip sport mip mport do

19

20

"$sportn != "•’ ) 21 22

23

24

25

26

27

28

29

30

31

32

33

34

35

36

37

38

39

40

41

42

43



if [    •- ”" -a H$mport"卜""-a "$sip"

then

LOG s==$mip~$mport==$sip«=s$sport LOG "stop slave”

mysql_cmd^"mysql -S /data/dbdata$sport/mysql.sock -u root” sql=Mstop slave” echo $sqlI $mysql一cmd sleep 1

sql==nshow slave status \GM echo $sqlJ $mysql_cmd LOG "get master log pos” sql=nshow master logs;”

mysql_cmd= Hmysql -urep -h$mip -P$mportn

LOG "$sql $mysql_cmdn

echo w$sqln J $mysql__cmd

TMP='echo ”$sql"| $mysql_cmdI tail -1'

MASTER一LOG一FILE='echo $TMP|awk 1{print $1}• '

MASTER一POS®'echo $TMPIawk 1{print $2}f '

LOG MASTER POSTMASTER POS ——    •*—

LOG MASTER_LOG_FILE«$MASTER_LOG_FILE LOG "gen change master sqln sql=" STOP SLAVE;change MASTER TO

MASTER一 HOST«1 MASTER一 IP、

MASTER_USER-1 rep•,

44

45

46

47

48



MASTER_PORT=MASTERS_PORT, MASTER_PASSWORD=f 1, MASTER_LOG_FILE=,MASTER__FILE,,

MASTER LOG POS=MASTER POS;

49    sql-'echo M$sqlM|sed "s/MASTER一工P/$mip/g"丨sed

"s/MASTERS_PORT/$mport/gn | sed Ms/MASTER_FILE/$MASTER__LOG__FILE/gn | sed "s/MASTER_POS/$MASTER一POS/g"'

50

51

52

LOG H$sql°

LOG ”execute change sql"

mysql_cmd="mysql 一S /data/dbdata$sport/mysql. sock ~u root*'

| 53   | LOG n$sql         | $mysql_cmd "     |      |      |
| ---- | ----------------- | ---------------- | ---- | ---- |
| 54   | echo "$sql        | \| $mysql cmd    |      |      |
| 55   | LOG "start        | slave”           |      |      |
| 56   | sql=Mstart        | slave"           |      |      |
| 57   | echo $sqlI        | $mysql_cmd       |      |      |
| 58   | sleep 1           |                  |      |      |
| 59   | LOG "check        | slave status"    |      |      |
| 60   | sql=’’show        | slave status \G” |      |      |
| 61   | echo $sqlI        | $mysql_cmd       |      |      |
| 62   | fi                |                  |      |      |
| 63   | done</tmp/.rebel. | conf             |      |      |
| 64   | }                 |                  |      |      |
| 65   |                   |                  |      |      |
| 66   | function main()   |                  |      |      |
| 67   | {                 |                  |      |      |
| 68   | setENV            |                  |      |      |
| 69   | process           |                  |      |      |
| 70   | }                 |                  |      |      |
| 71   |                   |                  |      |      |
| 72   | LOG "rebei start" |                  |      |      |
| 73   | main              |                  |      |      |
| mm   | LOG "rebei end*'  |                  |      |      |

243



关键代码：第31行通过“show master logs”获取主数据库的binlog文件列表，然后取出 最新的文件名和位置对应文件列表结果的最后一行。设置主从关系的“CHANGE MASTER” 命令为以下格式：

【示例8-21】

CHANGE MASTER TO option [r option] option:

MASTER_HOST - 'host一name*

I MASTER一USER = 1 user一name'

| MASTER_PASSWORD = 'password*

I MASTEH__PORT = port_num I MASTER_LOG__FILE = * master_log_name I MASTER_LOG_POS = master__log_pos

MASTER_HOST为主MySQL数据库服务器的IP，MASTER_PORT为主MySQL数据库 服务器监听的端口，MASTER_USER为主数据库服务器上分配给从数据库服务的用户名， MASTER_PASSWORD为对应密码，MASTER_LOG_FILE表示指定从数据库服务器启动热备 时读取的主数据库服务器binlog文件名，MASTER_LOG_POS为对应位置。

rebei.sh在从数据库所在机器执行，经过上面的步骤各个实例之间的主从关系已经设置完 毕，脚本执行过程中如有问题可以根据具体错误信息然后排查。

8.5.5搭建负载均衡LVS

LVS集群涉及的资源信息如表8.4所示。

表8.4 LVS资源信息说明

| 参数          | 说明                                 |
| ------------- | ------------------------------------ |
| 192.168.3.87  | LVS前端LD主机                        |
| 192.168.3.88  | LVS前端LD备机                        |
| 192.168.3.118 | LVS VIP                              |
| 192.168.3.100 | 部署了 MySQL实例主数据库，端口 10101 |
| 192.168.3.101 | 部署了 MySQL实例从数据库，端口 20101 |
| 192.168.3.102 | 部署了 MySQL实例主数据库，端口 10201 |
| 192.168.3.103 | 部署了 MySQL实例从数据库，端口 20201 |
| 192.168.3.200 | 这台机器可以登录并管理所有MySQL实例  |

根据以上资源，搭建LVS的步骤主要分为资源规划、内核编译、LVS软件安装，VIP设 置，真实服务器设置等步骤，LVS采用IP隧道模式，可以跨网段并且配置灵活，以下为详细 的操作步骤。

1.资源规划

本节要实现的是使用户通过VIP访问后端的MySQL服务器。正常情况下VIP设置在 192.168.3.87或192.168.3.87所在的机器。为当前端访问192.168.3.118上面的端口时LVS自动 转接到后端对应的MySQL应用。LVS代理信息说明如表8.5所示。

表8.5 LVS代理信息说明

| 实际IP地址   | VIP           | 访问的VIP端口 | MySQL实例所在IP | MySOL实例端口 |
| ------------ | ------------- | ------------- | --------------- | ------------- |
| 192.168.3.87 | 192.168.3.118 | 10101         | 192.168.3.100   | 10101         |
| 192.168.3.87 | 192.168.3.118 | 20101         | 192.168.3.101   | 20101         |
| 192.168.3.87 | 192.168.3.118 | 10201         | 192.168.3.102   | 10201         |
| 192.168.3.87 | 192.168.3.118 | 20201         | 192.168.3.103   | 20201         |

2.内核编译升级

由于采用LVS模式中的IP隧道模式，因此要确认内核支持IP隧道，确认命令如【示例

8-22】所示，如不支持，则需要重新编译内核。

【示例8-22】

\#确认系錄是考加载了 ipip模块和tunnel模块

[root@CentOS Packages]# Ismodlgrep ipip ipip    8371 0

tunnel4    2943 1 ipip

\#如系统不支持tunnel,则继续重新编译升级内核。

升级内核步骤如【示例8-23】所示。

【示例8-23】

[root@CentOS kernels]# cd linux-2.6.32.61 (root@CentOS linux-2.6.32.61]# make mrproper [root@CentOS linux-2.6.32.61]# make menuconfig

HOSTCC scripts/basic/fixdep

HOSTCC scripts/basic/docproc

HOSTCC scripts/basic/hash

HOSTCC scripts/kconfig/conf.o

HOSTCC scripts/kconfig/kxgettext.o

HOSTCC scripts/kconfig/lxdialog/checklist

出现内核编译设置界面，选择【Networking support】，然后选择【Networking options】，选 中【＜M〉IP: tunneling】，退出并保存设置。

【示例8-23】续 #生成内核文件

[root@CentOS linux-2.6.32.61]# make bzImage #编译内核模块

[root@CentOS linux-2.6.32.61]# make modules #安装模块

[root@CentOS linux-2.6.32.61)# make modules一install #安装内核

[root@CentOS linux-2.6.32.61]# make install #生成内核影像文件

[root@CentOS linux-2.6.32.61]# mkinitrd /boot/initrd__2.6.32.img 2.6.32 [root@CentOS linux-2.6.32.61]# cp arch/x86/boot/bz工mage /boot/vmlinuz-2.6.32 [root@CentOS linux-2.6.32.613# cp System.map /boot/System.map-2.6.32 #修改GRUB引导文件/boot/grub/menu.lst，增加以下内容到文件结尾

[root@CentOS # cat /boot/grub/menu.1st title CentOS (2.6.32-LVS-LD)

root (hdO,0)

kernel /vmlinuz-2.6.32 ro root=/dev/mapper/vg_centos-lv_root initrd /initrd_2.6.32.img

然后将文件保存，重启，进行系统引导时，选择“CentOS (2.6.32-LVS-LD)”，即可使用 编译好的内核。下一步进行LVS管理软件的安装。

\3. ipvsadm软件安装

ipvsadm采用的版本为ipvsadm-1.26.tar.gz，安装方式为从源码安装。安装过程如【示例 8-24】所示。

【示例8-24】

[root@CentOS soft]# tar xvf ipvsadm-1.26.tar.gz [root@CentOS ipvsadm-1.26]# make [rootGCentOS ipvsadm-1.26]# make install

安装完毕后主要的程序有3个：

•    /sbin/ipvsadm为LVS主管理程序，负责RS的添加、删除和修改

•    ipvsadm-save用户备份LVS配置

•    ipvsadm-restore 用于恢复 LVS 配置

ipvsadm常用参数说明如表8.6所示。

表8.6 ipvsadm常用参数说明

| 参数  | 说明                               |
| ----- | ---------------------------------- |
| —help | 查看帮助                           |
| -C    | 清空ipvs链表                       |
| -A    | 增加虚拟服务                       |
| -t    | 表示TCP服务                        |
| -a    | 表示添加某条链路服务至虚拟服务链路 |
| -r    | 真实服务器地址                     |
| -e    | 编辑虚拟服务                       |
| -d    | 删除某条虚拟服务                   |
| •i    | 表示IPIP隧道服务                   |

4.配置虚拟IP

客户端访问MySQL时，需要访问VIP和端口，然后LVS根据配置转到实际的MySQL 服务器，而MySQL服务器的真实IP对客户端是不可见的。配置虚拟IP需要在一台LD上和 所有MySQL数据库服务器上配置。

LD上配置过程如【示例8-25】所示。

【示例8-25】

[root@CentOS ipvsadm-1.26]# ifconfig tunlO 192.168.3.118 netmask 255.255.255.255

[root@CentOS ipvsadm-1.26]# ifconfig tunlO tunlO Link encap:IPIP Tunnel HWaddr



![img](11 CentOS7fbdfa1060ed0f49e18-182.jpg)



inet addr:192.168.3.118 Mask:255.255

UP RUNNING NOARP MTU:1480 Metric：1 RX packets:0 errors:0 dropped:0 over] TX packets:0 errors:0 dropped;0 over] collisions:0 txqueuelen:0

RX bytes:0 (0.0 b) TX bytes:0 (0.0 t

后端MySQL服务器设置命令如【示例8-26】所示。

【示例8-26】

[rootQCentOS 〜]# cat 一n tun.sh

1    #设置IP'转发

2    echo "0" >/proc/sys/net/ipv4/ip一forward

3    #设置VIP

4    /sbin/ifconfig tunlO up

5    /sbin/ifconfig tunlO 192.168.3.118 broadcast 192.168.3.118 netmask 255.255.255.255 up

6    #避免arp广播问题

7    echo 1 〉 /proc/sys/net/ipv4/conf/tunl0/arp一ignore

8    echo 2 > /proc/sys/net/ipv4/conf/tunlO/arp_announce

9    echo 1 > /proc/sys/net/ipv4/conf/all/arp一ignore

10    echo 2 > /proc/sys/net/ipv4/conf/all/arp一announce [root@CentOS # ifconfig tunlO

tunlO Link enc^p:IPIP Tunnel HWaddr

inet addr:192.168,3.118 Mask:255.255.255.255 UP RUNNING NOARP MTU：1480 Metric:1 RX packets:0 errors:0 dropped:0 overruns:0 frame:0 TX packet?:0 errors:0 dropped:0 overruns:0 carrier:0 collisions:0 txqueuelen:0

RX bytes:0 (0.0 b) TX bytes:0 (0.0b)



当客户端访问VIP时，会产生arp广播，由于前端负载均衡器和MySQL真实的服务器都 设置了 VIP，此时集群内的真实服务器会尝试回答来自客户端的请求，从而导致多台机器响应 自己是VIP,因此为了达到负载均衡的目的，需让真实服务器忽略来自客户端计算机的arp广 播请求。

\5. MySQL实例配置

确认VIP在前端负载均衡器和后端真实服务器上设置完毕后，然后进行MySQL实例的添 加，添加的命令如【示例8-27】所示。

【示例8-27】

[rootQCentOS # cat -n mysql_lvs.sh

1

2

ipvsadm -C #添加虚拟服务

| 3    | ipvsadm                                                      |      | -t   | 192.168.3.118:10101 | —s.  | wrr                 |      |      |      |
| ---- | ------------------------------------------------------------ | ---- | ---- | ------------------- | ---- | ------------------- | ---- | ---- | ---- |
| 4:   | ipvsadm                                                      | -A   |      | 192.168.3.118:10201 | —s   | wrr                 |      |      |      |
| 5:   | ipvsadm                                                      | -A   | -t   | 192.168.3.118:20101 | -s   | wrr                 |      |      |      |
| 6-   | ipvsadm                                                      | -A   | -t   | 192.168.3.118:20201 | -s   | wrr                 |      |      |      |
| 7    | #添加虚拟服务对应的真实服务器，每个虚拟服务后可踉多个一样的真实服务器 |      |      |                     |      |                     |      |      |      |
| 8    | ipvsadm                                                      | ’•a  | -t   | 192.168.3.118:10101 | -r   | 192.168.3.100:10101 | —i   | —w   | 9999 |
| 9    | ipvsadm                                                      | -a   | -t   | 192.168.3.118:20101 | -r " | 192.168.3.101:20101 |      | -w   | 9999 |
| 10   | ipvsadm                                                      | -a.  |      | 192.168.3.118:10201 | -r . | 192.168.3.101:10201 | *~i  | -w   | 9999 |
| 11:  | ipvsacim                                                     | -a   | -t   | 192.168.3.118:20201 | ~r   | 192.168.3.101:20201 | -i   | -w   | 9999 |

[root^CentOS bin]# ipvsadm 一Ln --sort IP Virtual Server version 1.2.1 (size=4096)

| Prot  | LocalAddress:Port Scheduler Flags      |      |         |        |                      |      |
| ----- | -------------------------------------- | ---- | ------- | ------ | -------------------- | ---- |
| ->    | RemoteAddress:Port                     |      | Forward | Weight | ActiveConn InActConn |      |
| TCP   | 192.168.3.118:10101192.168.3.100:10101 | wrr  | Local   | 9999   | 0                    | 0    |
| TCP-> | 192.168.3.118:10201192.168.3.101:10201 | wrr  | Tunnel  | 9999   | 0                    | 0    |
| TCP—> | 192.168.3.118:20101192.168.3.101:20101 | wrr  | Tunnel  | 9999   | 0                    | 0    |
| TCP~> | 192.168.3.118:20201192.168*3.101:20201 | wrr  | Tunnel  | 9999   | 0                    | 0    |

经过以上的步骤，MySQL服务在LVS中的设置已经完成，设置完毕后进行MySQL实例 的测试。可登录192.168.3.200,测试过程如【示例8-28】所示。

【示例8-28]

[root@CentOS # mysql -uadmin -padmin -hl92.168.3.118 -P10101 Welcome to the MySQL monitor. Commands end with ; or \g.

Your MySQL connection id is 7429710

mysql> show databases;

I Database    I

I information_scherna |. I test    I

2 rows in set (0.00 sec)

经过上面的步骤，使用LVS代理MySQL的步骤已经完成，通过LVS访问MySQL的需 求己经实现。每个LVS虚拟服务后可以添加多台MySQL实例，比如有两台或更多的从库部 署在不同的服务器上，数据相同，提供的是相同的服务，可以添加到共同的LVS虚拟服务中， 这样便可以实现MySQL访问的负载均衡。

第8章集群

'bu    .    ..

如果需要更高的可用性，需要对前端的负载均衡器做双机热备，常见的方案有Heartbeat 和keepalived，本节将采用Heartbeat作为双机热备的方案，可以做到在主节点故障时备节点迅 速接管服务。具体步骤将在下一节介绍。

8.5.6搭建双机热备HA

经过上一节的配置LVS已经可以正常提供服务，但为了保证更高的可用性，需要对前端 的复杂构衡器做双机热备，常见的方案有Hearbeat或keepalive,本节以hearbeat为例说明双 机热备的部署过程。

最新版本的Heartbeat可以支持前端负载均衡器的集群部署，本节的示例以Heartbeat双机 热备为例介绍部署过程。HA的部署要经过软件安装、配置文件设置、配置haresources、配置 authkeys和配置资源管理脚本儿个步骤。

\1. HA相关软件安装

Heartbeat本节采用的版本为2.1.4，首先安装HA需要的依赖库，然后进行HA软件的安 装，安装过程如【示例8-29】所示。

【示例8-29】

安装依赖软件

(root@CentOS ha]# tar xvf Libnet~l.1.6.tar.gz

[root@CentOS ha]# cd libnet-1.1.6

[root@CentOS libnet-l.1*6}# make

[rootGCentOS libnet-1.1.6]# make install

\#安装依赖

[root@CentOS ha]# tar xvf libxml2~2.7,7.tar.gz

[rootQCentOS ha]# cd libxml2-2.7.7

[root@CentOS libxml2~2.7.7]# ./configure

[root@CentOS libxml2-2.7.73# make

[root@CentOS libxml2-2.7.7]# make install

[root@CentOS ha]# tar xvf Heartbeat~2~l~STABLE-2.1.4.tar.bz2 [root径CentOS ha]# cd Heartbeat-2-1-STABLE-2.1.4]

[root@CentOS Heartbeat-2-l-STABLE-2,1.4]# ./ConfigureMe configure [root@CentOS Heartbeat-2-l-STABLE-2.1.4]# make [root@CentOS Heartbeat-2-1-STABLE-2.1.4]# make install

以上步骤如没有什么错误提示，则完成了 HA软件的安装，备节点部署过程同主节点。

2.两台负载均衡器配置hosts

配置HA需要的hosts,其中主机名需要与“hostname”输出相同。主备节点需要做同样 设置，如【示例8-30】所示。

【示例8-30]

[root@LD_192_168_3_87 -]# cat /etc/hosts

192.168.3.87    LD_192一168一3_87

192.168.3.88    LD_192_168_3_88

3.配置/etc/ha.d/ha.cf

/etC/ha.d/ha.Cf为HA服务的主配置文件，此文件指定了故障接管时的一些条件和参数，此 配置主备节点内容可以一致。文件内容如【示例8-31】所示。

【示例8-31】

[root@LD_192__168_3__87 〜]# cat /etc/ha.d/ha.cf

1    # heartbeat的日志存放位置

2    logfile /var/log/ha-log

3    #利用系统日志系统打印曰志

4    logfacility localO

5    #指明心跳时间为1秒，即每1秒钟发送一次广播

6    keepalive 1

7    #指定在10秒内没有心跳信号，则立即切换服务

8    deadtime 10

9    #当5秒钟内备份机不能联系上主机则写瞀告日志

10    warntime 5

11    #在某些配置下，重扃后网络需要一些时间才能正常工作，登台系统初始化完成

12    initdead 20

13指明心跳方式使用以太网广播方式，并且是在ethl接口上进行广播

14    beast ethl

15    #指定集群节点间的通信端口

16    udpport 10694

17    #当主节点恢复后，是否自动切回

18    auto_failback no

19    #集群~中机器的主机名，与“uname -n”的输出相同

20    node LD_192_168_3_87

21    node LD__192_168_3_88

4.配置/etc/ha.d/haresources

/etc/ha.d/haresources指定了需要备节点接管的资源，如IP资源，共享存储或其他主节点 故障时需要转移到备节点的资源。

【示例8-32】

[rootQCentOS    # cat /etc/ha.d/haresources

\#文件的末尾加上以下代码

LD_192_168_3_87 192.168.3.118 myop.sh

上述示例指定了 192.168.3.87为主节点，主节点故障时需要备节点接管的资源有虚拟

IP192.168.3.118，然后为myop.sh脚本指定的资源，其中myop.sh为一个可以接收“start”和 “stop”的服务。这个配置主备节点一致即可。

5.配置/etc/ha.d/authkeys

/etC/ha.d/aUthkeyS的作用是设置数字签名密钥和算法，此设置两个节点完全一样，设置步 骤如【示例8-33】所示。

【示例8-33]

[root@LD_l92_168_3_87 -]# cat /etc/ha.d/authkeys    ：‘

\#auth 表使3的if与下一条键值对应，各个节点指定的相同索引的字符要相同 auth 1

1 crc

\#更改文件的权限

[root@LD_192_168_3_87    # chmod 600 /etc/ha.d/authkeys

文件权限设置为“600”表示只有root用户可以操作此文件，如此文件属性未被正确配 置，Heartbeat程序将不能启动，同时打印错误信息。

6.资源管理脚本

HA在资源接管时需要执行特定的脚本以便初始化相关资源，如IP地址等HA提供了脚 本可直接调用，如需接管其他资源则需要编写程序辅助，本示例中的LVS设置属于此种情况。 编写的脚本为可以接收“start”和“stop”的脚本，用于初始化资源和取消相关设置。脚本内 容如【示例8-34］所示。

【示例8-34】

[root@LD一192一168_3一87 resource.d]# cat -n myop.conf

1    #!/bin/sh

2    export VIP=192.168.3.118

3    export broadcast=192.168.3.255

4    export netmask=255.255.255.0

[root@LD_l92_168_3_87 resource.d]# cat -n myop.sh

1    #!/bin/sh

2

3    #vip conf

4    . /etc/ha.d/resource.d/myop.conf

5

6    if [    "start” )

7    then

8    /sbin/ifconfig tunlO $VIP broadcast $broadcast netmask $netmask

9    #add rs

10    /sbin/ipvsadm -C

11    ipvsadm -A -t $VIP:10101 -s wrr

![img](11 CentOS7fbdfa1060ed0f49e18-184.jpg)



| 1213 - | ipvsadm -A -t. ipvsadm -A -t    | $VIP:10201$VXP:20101       |
| ------ | ------------------------------- | -------------------------- |
| 14     | ipvsadm -A -t:                  | $VIP:20201                 |
| 15     | ipvsadm -a -t                   | $VIP:10101:                |
| 16 :   | ipvsadm -a ~t                   | $VIP:20101                 |
| 丄/■18 | ipvsacun cl    u ■ipvsadm -a -t | 丄    •丄    丄.$VIP:20201 |
| 19     | elif [    "s                    | top"]                      |
| 20     | then                            |                            |

21    /sbin/ifconfig tunlO down

22    /sbin/ipvsadm -C



| -s wrr■ . . . ... ■ ■.        |      |      |      |
| ----------------------------- | ---- | ---- | ---- |
| ~s wrr                        |      |      |      |
| -s: wrr-r 192.168.3.100:10101 | -i   | ~w   | 9999 |
| -r 192.168.3.101:20101        | -i   | -w   | 9999 |
| -r 192.168.3.101:10201        | -i   | -w   | 9999 |
| -r 192.168.3.101:20201        |      | -w   | 9999 |

r r "    ■» 1



23 else



24    echo、 $0 "start!stop"

25    fi



上述示例中脚本myop.sh用于控制VIP和LVS虚拟服务的配置,接收“start”和“stop”

参数

7.启动HA服务

经过上面的配置，HA服务已经搭建完成，需要分别在两个节点上启动HA服务，启动后 可以用ps命令查看是否启动成功，启动命名如【示例8-35】所示。

【示例8-35]

| [root@LD 192 168 3 87 resource. — >— ——#启动后使用ps命令查看是否启动成功 | d] # service heartbeat start |                                            |
| ------------------------------------------------------------ | ---------------------------- | ------------------------------------------ |
| [root@LD_192_168_3_87 resource,d]#                           | ps -efIgrep heartbeat        |                                            |
| root                                                         | 15137 15075    0 16:11 pt,   | s/3    00:00:00 grep heartbeat             |
| root                                                         | 19726    1 0 2012 ?          | 00:02:08 heartbeat: master control process |
| nobody                                                       | 19728 19726 0 2012 ?         | 00:00:00 heartbeat: FIFO reader            |
| nobody                                                       | 19729 19726    0    2012 ?   | 00:07:32 heartbeat: write: ucast ethO      |
| nobody                                                       | 19730 19726 0 2012 ?         | 00:10:57 heartbeat: read: ucast ethO       |

如没有错误提示则正常启动了 HA服务，接下来将进行HA的测试。

8.5.7项目测试

经过上面的配置，LVS可以正常提供服务，HA已经生效，测试过程如下。

\1. LVS测试

设置完毕后登录192.168.3.200进行MySQL实例的登录测试，模拟用户的登录请求，登 录的用户名为admin,密码为admin,用户名和密码己经在安装MySQL实例时分配。

【示例8-36]

[rootSCentOS # mysql -u admin -p adrain -h 192.168.3.118 -P 10101

Welcome to the MySQL monitor. Commands end with ; or \g.

![img](11 CentOS7fbdfa1060ed0f49e18-185.jpg)



inysql> show databases;

2    rows in set (0.00 sec)

\2. HA测试

HA测试可以通过模拟故障，停止heartbeat进程或直接重启主机，然后观察备机是否接管 了主机的资源，测试过程【示例8-37】所示。

【示例8-37】

\#分别在主机启动heartbeat服务并验证服务是否正常 [root@LD_192_168_3_87-]# /etc/init.d/heartbeat start [root@LD_192_168_3_87 〜/etc/init.d/heartbeat status

heartbeat OK [pid 26545 et al] is running on ld_192_168_3_87 [Id一192一168一3一87]... #备机上启动heartbeat服务并验证服务是否正常    ™

[root@LD_192_168_3_88 〜]林 /etc/init.d/heartbeat start

[root@LD_192_168__3_88    # /etc/init,d/heartbeat status

heartbeat OK [pid 25073 et al] is running on Id一 192一 168_3_88 [ld_192_168__3_88]...

此时VIP位于主机192.168.3.87, LVS配置正常，重启主机192.168.3.87,观察备机

192.168.3.88 的臼志。

【示例8-38】

heartbeat[10414]: 2015/06/16__01:48:13 info: Received shutdown notice from ,ld_192_168_3_87,.

heartbeat[10414]: 2015/06/16一01:48:13 info: Resources being acquired from ld_192__168_3_87.

ResourceManager [10480] : 2015/06/16一01 •• 48 :14 info: Running /etc/ha,d/resource.d/IPaddr 192.168.3.118 start

\#部分结果省略 #接管IP资源

IPaddr[10583]:    2015/06/16_01:48:14 INFO: Using calculated nic for

192.168.3.118: ethO

IPaddr [10583] : 2015/06/16一01: 48 •• 14 INFO: eval if config eth0:0 192.168.3.118 netmask 255.255.255.0 broadcast 192,168.3.255

\#部分结果省略 #接管其他资源

ResourceManager[10768]: 2015/06/16_01:48:15 info: Running

/etc/ha,d/resource.d/myop.sh start

heartbeat[10414]: 2015/06/16_01:48:15 info: mach_down takeover complete. #检测到主机故障

heartbeat[10414]: 2015/06/16 01:48:25 WARN: node Id 192 168 3 87: is dead

以上日志中首先备机检测到了主机故障，然后根据预先的设置接管资源，并执行了自定义 的LVS脚本。检查命令如【示例8-39】所示。

【示例8-39】

\#备机已经接管IP资源

[root@LD 192 168 3 88 ha.d]# ifconfig •***

ethO Link encap:Ethernet HWaddr 00:0C:29:7F:08:9D

inet addr:192.168.3.88 Beast:192.168.3.255 Mask:255.255.255.0 inet6 addr: fe80::20c:29ff:fe7f:89d/64 Scope:Link

UP BROADCAST RUNNING MULTICAST MTU：1500 Metric:!

RX packets:7704 errors:0 dropped:0 overruns:0 frame:0 TX packets:30369 errors:0 dropped:0 overruns:0 carrier:0 collisions:0 txqueuelen:1000

RX bytes:871992 (851.5 KiB) TX bytes:9247215 (8.8 MiB) ethO:0 Link encap:Ethernet HWaddr 00:0C:29:7F:08:9D

inet addr:192.168；3.118 Beast:192.168.3.255 Mask:255.255.255.0 UP BROADCAST RUNNING MULTICAST MTU:1500 Metric:1

\#LVS资源己经接管

[root@LD_192_168_3_88 ha.d]# ipvsadm -Ln --sort

IP Virtual Server version 1.2.1 (size-4096)

Prot LocalAddress:Port Scheduler Flags -> RemoteAddress:Port    Forward Weight ActiveConn InActConn

TCP 192.168.3.118:10101 wrr

| 一> 192.168.3.100:10101 | Tunnel | 9999 | 0    | 0    |
| ----------------------- | ------ | ---- | ---- | ---- |
| TCP 192.168.3.118:10201 | wrr    |      | 欄   |      |
| -> 192.168.3.101:10201  | Tunnel | 9999 | 0    | 0    |
| TCP 192.168.3.118:20101 | wrr    |      |      |      |
| 一> 192.168.3.101:20101 | Tunnel | 9999 | 0    | 0    |
| TCP 192.168.3.118:20201 | wrr    |      |      |      |
| -> 192.168.3.101:20201  | Tunnel | 9999 | 0    | • 0  |

其他故障情况下的接管情况可根据实际情况进行测试。经过上面的介绍MySQL平台的高 可用部分已经介绍完毕，其他方面读者可参考其他资料。

8*6小结

集群技术已经成为目前应用的热点，本章主要介绍了传统的集群软件及集群的体系结构。 本章以集群软件LVS (Linux Virtual Server)及其负载调度算法为例，介绍了高可用集群的部 署过程及其应用。LVS提供了 3种负载均衡方式，NAT由于所有请求都需要经过前端的负载

均衡器，限制了集群的扩展；DR模式则需要集群中的真实服务器位于同一局域网，也同样限 制了其使用范围；相比而言隧道模式是最灵活的一种，可以跨网段甚至跨地域，需重点掌握。

MySQL因开源和容易使用的特点为众多开发者或大型公司所采用。随着MySQL实例的急 剧增长会带来一系列的问题，监控与容灾更需要平台化。本章最后以上百个MySQL实例作为 应用场景，从需求分析、可选方案、项目实现、项目测试等方面介绍LVS和HA在MySQL方 面的应用。HA主要用于主节点故障情况下的资源接管，LVS则主要保证日常访问的负载均衡。
