路由冒理►

对于Linux系统而言网络至关重要，这是因为大多数Linux服务器都依赖于网络。而数据 包在网络中从主机出发，经过传输、转发最终到达目标主机所依赖的是网络中的路由器。路由 器是根据路由条目转发数据包，因此路由管理的实质是路由条目管理。路由管理是运维人员的 重要工作之一，本章将介绍Linux系统中的路由管理。

本章涉及的主要知识点有：

•    路由的基本知识

•    路由的分类

•    配置Linux路由

•    策略路由

![img](11 CentOS7fbdfa1060ed0f49e18-69.jpg)



认识路由



路由不仅存在于路由器中，也存在于操作系统中，不仅Linux系统有，Windows中也存在。 本节将简单介绍路由的概念。

4.1.1路由的基本概念

路由器传递数据包的方法与现代邮政系统工作机制相似，先按行政区域划分设立邮局。如 果信件传递仅发生在邮局内部，则直接分拣投递即可，例如北京市东城区某小区发往东城区另 一小区的信件，只需在东城区邮政局分拣投递即可。如果信件发往外埠则需要借助邮政局间的 运输网络，例如由北京市东城区发往四川省成都市成华区的邮件，则需要东城区邮政局将邮件 交由北京市邮政局，再由北京市邮政局通过运输网络发往四川省，然后层层下发直到邮件到达 收件人手中。

数据包的传递过程与邮政系统类似，也是先将计算机分组划分成不同子网，然后通过子网 间的路由器传递数据包，如图4.1所示。

192.168.1.1 MAC： E



192.168.0.1



PCI

IP: 192.168.0.2 MAC： A



192.16X.0.1

MAC:D



192.I6S.I.2 MAC： H



![img](11 CentOS7fbdfa1060ed0f49e18-70.jpg)



PC3

IP: 192.168.2.2 MAC? C



PC2

IP: 192.168.0.3 MAC： B



图4.1子网拓扑

在图4.1中共有2个交换机和路由器及3台计算机,共包含192.168.0.0/24、192.168.1.0/24、 192.168.2.0/24 3个子网，本例中各设置的IP地址等信息均已在图中。需要特别说明的是图中 所示的MAC地址正确格式应为“00-51-5B-C0-00-08”或“00:51:5B:C0:00:08”，此处为方便 说明简写为A、B、C等格式。

与邮政系统类似，当数据包发送的目标地址为同一子网时，数据包由交换机直接传送给目 标主机。例如当PC1发送数据包给PC2时，PC1会首先发送ARP广播寻找PC2的MAC地址, ARP广播会发送给子网192.168.0.0/24中的所有计算机。图中所示的PC2和IP地址为 192.168.0.1的路由器接口均会收到广播，但只有PC2会回应PC1的广播并将其MAC地址反 馈给PC1。当PC 1收到PC2的MAC地址后，将目的IP、MAC地址正确写入数据包，然后交 由交换机发送给PC2，数据包传输过程完成了。

另一种情况是PC1发送的数据包目的地址与PC1不在同一子网时，这时就与邮政系统类 似，PC1会将数据包交给自己的“上级"默认网关。例如在图4.1中PC1发送数据包给PC3, 数据包发送过程如下：

(1)    由于PC1与PC3的地址不在同一子网，因此PC1会将数据包的MAC地址修改为D 发送出去，交换机会将数据包交给192.168.0.1，即路由器。

(2)    与路由器相连的网络分别为192.168.0.0/24和192.168.1.0/24,因此路由器并不知道 网络192.168.2.0/24位于何处，此时就需要借助路由条目的帮助。为了能将数据包成功发往 PC3,路由器中就需要一条指向192.168.2.0/24的路由条目，这个条目指明数据包的下一跳地 址为 192.168.1.2。

(3)    根据路由条目指示，路由器会将数据包目的MAC地址修改为F将数据包发送给路 由器2。

(4)    路由器2与192.168.2.0/24直接相联，因此收到数据包后，路由器2会将目的MAC 修改为C发送给交换机，交换机再将数据包交给PC3,数据包传输完成。

纵观上述过程，无论是数据包发送给默认网关，还是由一个路由器发送给另一个路由器，

都离不开路由的参与。

4.1.2路由的原理

在4.1.1节中介绍了路由的基本作用，但路由运作的机制比较复杂，本小节将简要介绍路 由的基本原理。

一个路由条目至少包含3个要素：子网，子网掩码和下一跳地址（在有些设备中使用的是 下一跳设备），其主要含义如下：

•    子网：目标子网的网络号，默认路由的子网号为0.0.0.0。

•    子网掩码：目标子网的子网掩码，默认路由的子网掩码为0.0.0.0。

•    下一跳地址：目标子网数据包的转发地址。在有些路由器中可以使用下一跳设备，设 备通常是本地接口。

通常计算机中会有多条路由条目，计算机发出数据包时会进行计算，将目标IP地址与路 由条目中的子网掩码按位与，即二进制按位做乘法。如果按位与的结果与路由条目的子网相 同，贝採用此路由条目的下一跳地址作为转发目的地。例如在图4.1中，路由器发往PC3的数 据包地址为192.168.2.2，与192.168.2.0/24网络的子网掩码按位与的结果为192.168.2.0,与子 网相同，因此就会将数据包转发给192.168.1.2。

无论是计算机还是路由器，在计算路由时都遵循精确匹配原则，即如果多条路由条目都匹 配目标地址，则使用最精确的条目作为转发路径。例如IP地址192.168.2.2能同吋匹配 192.168.0.0/16和192.168.2.0/24,但基于精确匹配原则，最终将使用192.168.2.0/24这条路由 条目。

4.1.3 Linux系统中的路由表

在计算机中通常不止一个路由条目，能正常通信的计算机至少有两个路由条目，而路由器 中的路由条目可能会更多。这些路由条目存储于路由表中，如果要在Linux系统中查看路由表， 可以使用route命令，如【示例4-1】所示。

【示例4-1】

| [root@localhost    # route |             |                    |        |      |      |             |
| -------------------------- | ----------- | ------------------ | ------ | ---- | ---- | ----------- |
| Kernel IP routing table    |             |                    |        |      |      |             |
| Destination                | Gateway     | Geninas k    Flags | Metric | Ref  | Use  | I face      |
| default                    | 172.16.45.1 | 0.0.0.0    UG      | 0      | 0    | 0    | enol6777736 |
| 172.16.45.0                | 0.0.0.0     | 255.255.255.0 U    | 0      | 0    | 0    | eno!6777736 |

在示例4-1中，命令输出了两个路由条目，第一条是指向默认网关的默认路由，第二条是 与计算机直接相连的子网路由。命令输出中Flags字段中的U表示路由条目可用，G表示正在 使用的网关。

4.1.4静态路由和动态路由

在4.1.1小节中介绍了数据包如何从PC1发送到PC3的整个过程，当数据包到达 192.168.0.1后，路由器将会计算下一步的路径，其依据就是路由器中保存的路由条目。本小节 将介绍这些路由条目的来源及分类。

路由的来源有三种，第一种是路由器和计算机根据自身的网络连接自动生成的直联路由， 即与自身所在同一子网的路由，只要网络持续连接直联路由就会一直存在并生效；第二种是由 管理员手动添加的静态路由，静态路由仅适合于网络运作简单的环境，Linux系统中添加的路 由多为静态路由：最后一■种是由动态路由协议生成的动态路由。

静态路由的缺点很明显，当路由器数量增加时，子网数量也増多，这时就需要在每个路由 器上为每个子网添加路由，否则就会出现无法访问的问题。如果其中一台路由器出现问题，路 由条目秫会失效，也会造成无法访问的问题。

为了解决静态路由的这些问题，动态路由协议应运而生，动态路由协议会根据网络状况调 整各路由器的路由条目，最大程度上保持网络通畅。常见的动态路由协议有RIP、OSPF、BGP、 IGRP 等。

(1)    RIP (Routing Information Protocol,路由信息协议)是最简单的路由协议，RIP协议 要求路由器以30秒为周期，向相邻的路由器交换信息，从而让每个路由器都建立路由表。RIP 建立的路由表以距离为单位，通过一个路由器称为一跳，RIP总是希望数据包通过最少的跳数 到达目的地。RIP最大的优点是配置简单，但仅适用于小型网络，如果跳数超过15,数据包 将不可达。由于路由器每30秒向相邻路由器交换信息，因此RIP协议的收敛时间相对较长(收 敛时间是指路由协议让每个路由器建立精确并稳定的路由表的时间长度，时间越长，网络发生 变化后，路由表生成得越慢，网络稳定需要的时间也越长)。

(2)    OSPF (Open Shortest Path First,开放最短路径优先)是一个相对比较复杂的动态路 由协议。OSPF—般用于一个路由域内，称为自治系统(Autonomous System)。在这个自治系 统内部，所有加入到OSPF的路由器都会通过路由协议相互交换信息，以维护自治系统的结构 数据库，最后路由器会通过数据库计算出OSPF路由表。与RIP相比，OSPF协议根据链路状 态计算路由表，更适合于大型网络，其收敛速度也更快。

(3)    BGP (Border Gateway Protocol,边界网关协议)是一个用来处理自治系统之间的路 由关系的路由协议，最适合处理像Internet这样十分巨大的网络。BGP即不完全是距离矢量协 议，也不完全像OSPF那样使用链路状态，BGP使用的是通路向量路由协议。BGP使用TCP 协议进行可靠的传输，同时还使用了路由汇聚、增量更新等功能，极大地增加了网络可靠性和 稳定性。

(4)    IGRP (Interior Gateway Routing Protocol,内部网关路由协议)是由 Cisco 公司设计 的专用于Cisco设备上的一种路由协议。IGRP是一种距离向量路由协议，其要求路由器以90 秒为周期向其相邻的路由器发送路由表的全部或部分，由此区域内的所有路由器都可以计算出 所有网络的距离。由于使用网络延迟、带宽、可靠性及负载等都被用作路由选择，因此IGRP 的稳定性相当不错。

动态路由协议除了上面介绍的4种之外，还有许多例如IS-IS等，此处不再赘述，感兴趣 的读者可自行参考相关资料了解。

配置Linux静态路由

与其他操作系统不同，Linux系统作为常见的服务器操作系统，其可能会遇到更多样的网 络环境。除了常见服务器使用的Internet网络连接外，通常还会有公司内部网络，远程访问相 关的网络等，此时就需要正确设置路由，否则就无法正确访问。本节将简要介绍如何在Linux 系统中设置静态路由。

4.2.1配置网络接口地址

设置静态路由的前提是网络接口上配置有ip地址等信息，否则路由条目无法生效。在网 络接口上配置单个IP地址的相关知识已在第3章中介绍过，此处介绍如何在同一接口上配置 多个IP地址的方法。

(1)使用子接口

使用子接口在网络接口上配置多个IP地址是一个比较常见的做法，子接口名字形如： eno 16777736:1,其中enol6777736是网络接口的名称，“:1”则表示这是一个子接口。配置过 程如【示例4-2】所示。

【示例4-2】

(rootSlocalhost -]# ifconfig enol6777736:1 172.16.45.134/24 up [rootglocalhost •*] # ifconfig

enol6777736:l: flags=4163<UP,BROADCAST,RUNNING,MULTICAST> mtu 1500

inet 172.16.45.X34 netmask 255.255.255.0 broadcast 172.16.45-255 ether 00:0c:29:23:7c:d2 txqueuelen 1000 (Ethernet)

使用以上命令配置的子接口将在重启后消失如需要重启后继续生效则需要将上述命令写 入文件/etc/ec.local 中。

(2)使用多配置

CentOS 7允许在一个网络接口上配置多个不同IP地址、子网掩码、网关和DNS服务器 地址等，但同时只能激活一个配置。多配置在图形界面中可以单击“Applications”，然后在弹 出的菜中依次单击“System tools”、“Settings”，打开设置界面，如图4.2所示。

Personal



Settings



tQ|'





Background Notifications



Online

Accounts



Privacy



Region & Language



湖

Search



Hardware



Bluetooth



Power



| Color    | 醐               | Keyboard     | ih   | 囅   |
| -------- | ---------------- | ------------ | ---- | ---- |
| Displays | Mouse & Touchpad | Network      |      |      |
|          |                  |              |      |      |
| Printers | Sound            | Wacom Tablet |      |      |



System



Date & Time    Details



Sharing



&

Universal

Access



Users



图4.2设置界面

在设置界面中可以找到CentOS 7中几乎所有的常规设置，此时单击“Network”弹出网络 设置界面，如图4.3所示。

![img](11 CentOS7fbdfa1060ed0f49e18-71.jpg)



Settings

Network



Airplane Mode「: OFF



![img](11 CentOS7fbdfa1060ed0f49e18-72.jpg)



Wired

Connected - 1000 Mb/s

Address 172.16,45 16

fPv© Address, fe80:.20c:29ff:Fe23:7cd2

Hardware Address 00:0C：29:23;7C;D2

Defwk Rowte 172,16.45.1

172.16.1.9 61.139.2.69

Add Profile...



图4.3网络设置界面

在网络设置界面中可以看到网络接口相关设置，此时可以单击“Add Profile”按钮为已连 接网络连接添加配置文件。添加配置文件界面如图4.4所示。

| ! Server :L一训二二: |      |           | ■ i           |
| -------------------- | ---- | --------- | ------------- |
|                      |      |           |               |
|                      |      |           |               |
|                      |      |           |               |
|                      |      |           | .........'_」 |
| Routes               |      | Automatic |               |

Address

Netmask

New Profile

IPv6



Automatic (DHCP)

⑽敝曬:]



Cancel.    Add

1____



图4.4添加配置文件

在新配置中可以添加诸如802.1x、IPv4等类型网络，以常见的IPv4网络为例，可以在左 侧选择IPv4,然后在右侧的“Addresses”中选择“Manual”。然后就可以在下面填入IP地址、 子网掩码、网关、DNS、静态路由等信息。

多次添加即可在同一个网络连接上添加多个配置文件，这些配置文件可以在网络设置界面 的右侧看到，如图4.5所示。

Wired

Connected - 1000 Mb/s

\ Profile 2

Profile 1 enol6777736

曜

Aikirsss. 172.16.45.16

Addres：. fe80;:20c:29ff:fe23;7cd2

Hardware    0O;0C:29:23：7C：D2

Default Route 172.16 45.1

DNS 172 16 19 61.139 2 69

:Add Profile,.

图4.5网络连接的多配置文件

添加了多配置文件后，接下来的任务就是切换配置文件让不同的配置文件在不同的网络环

境中生效。切换配置文件需要单击桌面右上角的联网图标菜单，将弹出所有的配置文件列表， 如图4.6所示。

zh



Mon 18:08 root



Wired

•轨伽7Tm&

Profile 1

Profile 2

Network Settings

图4.6网络配置文件列表

此时只需要单击对应的配置文件名称，就可以让相应的配置文件生效，如果系统重启则采 用上一次生效的配置文件。

4.2.2接口 IP地址与直联路由

无论使用哪种方式为网络接口配置ip地址等信息，只要网络接口接入某个子网，路由表 都会立即为子网添加相应的直联路由。可以使用route命令查看路由表验证，如【示例4-3】 所示。

【示例4-3】

| [root@localhost    # route ~nKernel IP routing table | Flags Metric Ref   |                |      |       |
| ---------------------------------------------------- | ------------------ | -------------- | ---- | ----- |
| Destinationdefault                                   | Gateway172.16.45.1 | Genmask0.0.0.0 |      |       |
| UG                                                   | 100 0              |                |      |       |
| enol6777736172.16.45.0                               | 0.0.0.0            | 255.255.255.0  | U    | 100 0 |
| enol6777736                                          |                    |                |      |       |

Use Iface 0

0

在【示例4-3】的命令输出中第二条就是与172.16.45.0子网的直联路由，这是由接口 enol6777736的IP配置决定的。如果此接口的IP地址发生变化或有新的接口拥有了 IP地址， 路由表中的直联路由也会发生变化，如【示例4-4】所示。

【示例4-4】

[rootSlocalhost -]# ifconfig eno!6777736:1 192.168.1.100/24 up

[root@localhost # route -n

| Kernel IP routing table |             |                 |       |        |      |      |             |
| ----------------------- | ----------- | --------------- | ----- | ------ | ---- | ---- | ----------- |
| Destination             | Gateway     | Genmask         | Flags | Metric | Ref  | Use  | Iface       |
| default                 | 172.16.45.1 | 0.0.0.0         | UG    | 100    | 0    | 0    | enol6777736 |
| 172.16.45.0             | 0.0.0.0     | 255.255.255.0   | U     | 100    | 0    | 0    | enol6777736 |
| 192.168.1.0             | 0.0.0.0     | 255.255.255.0 i | U     | 0      | 0    | 0    | eno!6777736 |

由以上示例可以看到当接口的IP地址发生改变后，路由表中的直联路由也发生了改变。

4.2.3 route 命令

在Linux系统中，查看、添加、删除路由的是route命令。其添加删除路由时的基本格式 如【示例4-5】所示。

【示例4-5】

route add|dell [一net丨一host] ipaddressl netmask netmask gw ipaddress2|dev

各项参数含义如下：

•    add|del:表示添加或删除一个路由条目。

•    -net|-host:路由条目的目的地是一个子网或一台主机。

•    ipaddressl:目标子网的子网号或目标主机的IP地址。

•    netmask:目标子网或主机的子网掩码，当目标为主机时，子网掩码长度应为32位。

•    gw:用于指定下一跳地址或下一跳设备。通常将Linux作为一台路由器使用时才会 使用下一跳设备。

除以上列举的参数之外，还有一个用于显示路由表时使用的选项n,此选项表示使用IP 地址显示而不尝试使用域名。IP地址转换为域名需要解析，因此使用选项n可以快速显示路 由表，如【示例4-6】所示。

【示例4-6】

| [rootQlocalhost H# route -n |             |               |       |        |      |      |             |
| --------------------------- | ----------- | ------------- | ----- | ------ | ---- | ---- | ----------- |
| Kernel IP routing table     |             |               |       |        |      |      |             |
| Destination                 | Gateway     | Genmask       | Flags | Metric | Ref  | Use  | rface       |
| default                     | 172.16.45.1 | 0.0.0.6       | UG    | 100    | 0    | 0    | enol6777736 |
| 172.16.45.0                 | 0.0.0.0     | 255.255.255.0 | U     | 100    | 0    | 0    | enoX6777736 |

【示例4-6】所示的命令输出了系统内核的路由表，路由表中的几个字段含义如下：

•    Destination:目标网络号或目标主机IP地址，default表乐这是一条默认路由.

•    Gateway:网关地址即下一跳地址，其中0.0.0.0或表示主机与该子网直接相联 无须下一跳地址（直联路由）。

•    Genmask:子网对应的子网掩码.

•    Flags:路由标记。

•    Metric:路由条目的代价值。Metric数值越高代价越大，此值一般在有多条到目标网 络的路由时才起作用。

•    Ref:路由条目被引用的次数。

•    Use:路由条目被路由软件查找的次数。

•    Iface:到达目标网络使用的本地接口。

在上面的字段中，Flags路由标记用于指示路由条目的状态，常见的状态标记及含义如下：

•    U:当前路由处于活动状态（可用状态）。

•    H:路由条目的目标是主机而不是子网。

•    G:指向默认网关的路由。

•    R:恢复动态路由产生的路由。

•    D:由后台程序动态产生的。

•    M:此条目经过了后台程序修改。

•    C:缓存的路由条目。

•    !:拒绝路由。

route命令还可以用于添加默认路由（通常称为默认网关），但更多的是用于添加静态路 由，使用方法如【示例4-7】所示。

【示例4-7】

\#添加删除默认路由

[rootglocalhost -]# route add default gw 172.16.45.1 [root@localhost -}# route del default gw 172.16.45.1 #添加、删除到网络的路由

\#子网掩码采用不同的形式，因此以下两条语句的功能相同

[root@localhost 林 route add -net 192.168,19.0/24 gw 172>16.45.100 [root@localhost -3 # route add -net 192.168.19.0 netmask 255.255.255.0 gw

172.16.45.100

[root@localhost 〜route -n

| Kernel IP routing table |               |                                       |       |            |           |      |
| ----------------------- | ------------- | ------------------------------------- | ----- | ---------- | --------- | ---- |
| Destination             | Gateway       | Genmask                               | Flags | Metric Ref | Use Iface |      |
| 0.0.0.0                 | 172,16.45.1   | 0.0.0.0                               | UG    | 100 i      | 0         | 0    |
| enol6777736172.16.45.0  | 0.0.0.0       | 255.255.255.0                         | u     | 0          | 0         | 0    |
| enol6777736192.168.19.0 | 172.16.45.100 | ,• \5,    *■ v • ,    ,V255.255.255.0 | UG -  | 0          | 0         | 0    |

enol67?7736

[root@localhost # route del -net 192.168,19.0/24 #添加删除劐主机的路由

[root@localhost -}# route add -host 192*16$.100.80 gw 172.16.45.100 [root@localhost -}# route -n Kernel IP routing table

| Destination    | Gateway         | Genmask       | Flags          | Metric Ref | Use  |
| -------------- | --------------- | ------------- | -------------- | ---------- | ---- |
| 0.0.0.0        | 172.16.45.1     | 0.0.0.0       | UG             | 100 0      | 0    |
| enol6777736    |                 |               |                |            |      |
| 172,16.45^0    | 0.0.0.0         | 255.255,255.0 | □              | 100 0      | 0 :  |
| eno!6777736    |                 |               |                |            |      |
| 192.168.100.80 | 172.16.45.100： | 255.255.255,  | 255 UGH 0    0 |            |      |

eno!6777736

[root@localhost -]# route del -host 192.168.100.80

89

4.2.4 Linux路由器配置实例

学习完之前的基本知识之后，可以利用Linux来制作一个路由器。本小节将简单介绍路由 器包括的功能及如何将Linux配置成一个实用的路由器。

一个实用的路由器最起码应该包括DHCP、数据包转发、NAT等，DHCP用来为子网中 的计算机分配IP地址、网关、DNS等信息：数据包转发是路由器的核心功能，用来将数据包 准确地转发到相应的子网；NAT功能用来作地址转换，即将子网发往外部网络的数据包地址 作转换。在Linux系统上配置路由器可以采取两个方案，其一是使用Linux自身的内核转发功 能、配置DHCP服务并使用防火墙的地址伪装作NAT功能：其二是使用其他路由软件，例如 著名的Zebra等。本小节将采用Linux内核的数据包转发功能作为示例讲解。

在本节的路由器配置中，采用的拓扑图如图4.7所示，路由器的一端连接子网 192.168.0.0/24。

在开始配置路由器之前，需要先为路由器和子网计算机上的网络连接正确配置IP地址， 确保路由器能正常访问外部网络。配置子网计算机时，默认网关应该为192.168.0.1。配置完 IP地址后，接下来需要配置内核转发，让内核具有转发数据包的功能，如【示例4-8】所示。

【示例4-8】

\#添加内核转发参数

[root@localhost ~]# cat /etc/sysctl.conf

net.ipv4,ip_forward = 1 #让内核参数生

[rootQlocalhost # sysctl net.ipv4.ip forward = 1

这样Linux就具备了数据包转发功能，接下需要让Linux防火墙具备NAT功能，这个功 能通常由防火墙iptables来完成，如【示例4-9】所示。

-【示例4-9]

\#禁用并停止firewalld

[rootQlocalhost 〜]# systemctl disable firewalld [rootSlocalhost # systemctl stop firewalld #安装iptables防火墙

[root®localhost ~]# yum install ~y iptables-services #启用并开启iptables

[root@localhost -]# systemctl start iptables [root@localhost ~]# systemctl enable iptables #在enol6777736接口上开启地址伪装

(rootglocalhost -]# iptables -t nat -I POSTROUTING -o enol6777736 -j MASQUERADE

接下来就可以在子网计算机上访问外部网络了，可以通过ping命令、curl访问网址等方 式验证。

![img](11 CentOS7fbdfa1060ed0f49e18-75.jpg)



由于本书的第3章已介绍过DNS、 资料配置。



DHCP等知识，此处不再赘述，读者可自行参考相关



^•3 Linux的策略路由

传统的路由是一个指向目标子网的“指路牌”，任何人来“问路”，路由都会明确指向目标。 传统路由这种“不问来人情况”的处理策略越来越不适合现代计算机网络，举例来说“行人与 汽车”走的“路”应该是不同的。这样策略路由就兴起了，策略路由是近些年来兴起的一个比 较新的路由概念。策略路由可以根据多种不同的策略，决定数据包通过的路径。本节将简要介 绍Linux系统中的路由及策略路由的使用。

4.3.1策略路由的概念

并不是所有环境都适合策略路由，首先策略路由与传统路由相比最大的不同是，策略路由 通常有不止一条到达目的网络的路径，例如在一个网络中有两个出口联通和电信等。因此策略 路由在企业的实施环境首要条件网络有多个出口，例如一电信一联通，又如一出口速度较快， 另一出口速度相对更慢一些等。

策略路由按实现的方式大体可以分为三类，第一种是按目的地址进行路由，即根据目的地 不同选择不同的出口。由于这种按目的地址进行路由的方法特别适合做双线服务器，因此在国 内使用的较多。第二种是按源地址进行路由，即根据发出数据包的计算机地址决定选择哪个出 口，这种方法适用于多种环境，例如多线机房，客户定制的更快速的网络等。第三种是智能均 衡策略路由，这是一种出现时间较晚的方式，在这种方式下，会自动识别网络带宽及负载，根 据带宽和负载动态地决定数据包从哪个出口发出。

无论使用何种策略路由，都必须注意保护连接的持续性，特别是在出口上使用了 NAT的 网络中。即需要保证内部网络主机与外部通信时，数据包的往返都使用的是同一出口，否则可 能会造成资源浪费甚至无法连接的情况出现。

4.3.2路由表管理

在Linux系统中，策略路由可以通过路由表来实现，但Linux系统中的路由表并不像普通 路由器那样简单，本小节将介绍Linux系统中的路由表。

默认情况下Linux并非只有一个路由表，因为如果系统中只有一个路由表，策略路由的许 多功能将无法实现。数据包转发时，并不需要将所有路由表都搜索计算一次，数据包应该使用 哪个路由表路由，取决于系统设定的规则。查看系统默认的规则使用命令“ip rule list”或“ip rule show”，如【示例4-10】所示。

【示例4-10】

[root<31 ocalhost 〜]# ip rule list

0:    from all lookup local

32766: from all lookup main

32767: from all lookup default

【示例4-10】展示的是没有经过修改的Linux系统规则列表，这其中输出了 3个路由表 local、main及default。每条规则前面的数字表示规则的优先级，数值越小表明优先级越高， 而“from all”表明所有的数据包都需要经过路由表的匹配。

由此可以看出【示例4-10】所示的处理过程应该是，内核转发的数据包先使用表local转 发，如果没有匹配的路由条目再依次使用表main和default。为了搞清Linux系统数据包的转 发流程，有必要搞清这三张路由表的内容，如【示例4-11】所示。

【示例4-11】

[2：oot@localhost # ip route list table local

broadcast 127.0.0.0 dev lo proto kernel scope link src 127.0.0.1 local 127.0.0.0/8 dev lo proto kernel scope host src 127.0,0.1 local 127.0.0.1 dev lo proto kernel scope host src 127.0.0.1 broadcast 127.255.255,255 dev lo proto kernel scope link src 127.0.0.1 broadcast 172.1-6.45.0 dev enol6777736 proto kernel 參cope link src 172.16.45.13

local 172,16.45.13 dev eno!6777736 proto kernel scope host src 172.16.45.13 broadcast 172.16.45.255 dev enol6777736 proto kernel scope link src 172.16.45.13

[root@localhost -]# xp route list table main    4

default via 172.16.45.1 dev enol6777736 proto static metric 100 172.16.45.0/24 dev enol6777736 proto kernel scope link src 172.16.45.13 172.16.45.0/24 dev eno!6777736 proto kernel scope link src 172.16.45.13 metric 100

[root@localhost 者 ip route list table default

[root@localhost #

【示例4-11】分别输出了 3张路由表中的路由条目，其中表default中的路由条目为空， 此处不作讨论。由于计算机的IP地址为172.16.45.13,因此表local中的路由条目为来自广播

和目的地为本地接口 IP的数据包路由。而表main中的路由条目，很明显是指向本地子网（即 子网172.16.45.0/24）和指向默认网关的默认路由。

由于环境并不复杂，系统默认的规则中并没有决定哪些数据包应该使用具体的某个路由 表。但了解Linux系统的路由表机制后，接下来我们就可以利用这些机制建立自己需要的路由 表和规则。建立一个路由表和相应的规则如【示例4-12】所示。

•【示例4-12】

\#建立一个名为testl的路由表

[rootglocalhost # echo 100 testl » /etc/iproute2/rt_tables #建立一个规则，规定所有来自192.168.19.0/24的数据包都使用路由表testl中的条目路由 [root@ldcalhost ~# ip rule add from 192.168.19.0/24 table testl #列出规则

[root@localhost # ip rule list

0:    . from all lookup local

32765: from 192.168.19.0/24 lookup testl

32766: ftom all lookup main

32767: from all lookup default，

在【示例4-12】中，先使用编辑rtjables的方式添加了一个名为testl的路由表，然后添 加了一条规则，规定所有源地址为192.168.19.0/24的包通过testl路由表路由。由于我们并没 有向路由表testl中添加任何路由条目，因此此时路由表testl还为空，如何添加将在下个小节 中介绍。

添加testl路由表时，使用了数字100作为保留值（保留值为table ID, testl相当于table ID 的别名，此值与优先级无关，优先级将自动分配），通常建议这个值小于253且不重复，具体 可以查文件中的说明。除了以上这种编辑文件的方法外，还可使用指定table ID的 方法添加路由表，如【示例4-13】所示。

【示例4-13】

[root@localhost ~]# ip rule add from 192.168.18.0/24 table 2 pref 1500 prohibit

以上示例将添加一个table H）为2的路由表，并指定其优先级为1500。

删除路由表与以上过程相反，首先需要删除相关的规则，然后再编辑文件11_131）1^，删除

其中的相关配置，如【示例4-14】所示。

【示例4-14】

善删除规则和rt_tables中的相关内容 [rootslocalhost # ip rule del table testl [root径localhost -*] # cat /etc/iproute2/rt_tables

番

\# reserved values

| ##1                               | inr.ruhep               |
| --------------------------------- | ----------------------- |
| #验证结果                         |                         |
| [rootQlocalhost    # ip rule list |                         |
| 0:                                | from all lookup local   |
| 32766:                            | from all lookup main    |
| 32767:                            | from all lookup default |

系统重启后，规则将失效nii续生效可以将iii则的相关语句写入/etc/rc.local中。

............................................................................ ...................................................................... —

4.3.3规则与路由管理

从前面几个小节的介绍中不难看出，Linux策略路由管理的两个核心分别是规则与路由表 中路由的管理。虽然之前已经介绍过路由管理的相关概念，但与之前的路由管理相比，此处将 要麻烦一些，因为在策略路由中还需要细化一些参数。

1.规则

在策略路由中，规则如同一个筛选器，将数据包按预先的设置“送给”路由表，完成路由 过程，添加一条规则使用命令ip，格式如下：

Ip rule [add丨del] SELECTOR ACTION

在以上格式中，“[add|del]”表示添加或删除一条规则，“SELECTOR”表示数据包选择 部分，“ACTION”表示执行的操作。其中“SELECTOR”可以选择数据包的多种选项，常见 选项如下所示：

•    from:源地址。

•    to:目的地址。

•    tos:数据包的TOS ( Type of Service )域，用于标明数据包的用途。

•    fwmark:防火墙参数。

•    dev:参与设备，具体包括两个选项iif和oif，分别表示接收和发送设置匹配。

•    pref:指定优先级。

在以上选项中，无疑from和to是最常用的选项。除以上选项外，还有一些其他选项，读 者可阅读相关文档了解或参考ip-rule的手册页。

与“SELECTOR” 一样，“ACTION”执行的动作也有多种：

•    table:指明使用的table ID或表名。

•    nat:透明网关，同NAT相4以。

•    prohibit:丢弃包并返回 “Communication is administratively prohibited” 的错误消息。

•    unreachable:丢弃包并返回 “Network is unreachable” 的错误消息。

•    realms:指定数椐包分类，此选项主要用于配合tc作流量整形。

“ACTION”执行的动作中，table和nat是最常用的，prohibit和unreachable主要用来禁

止通信，因此使用较少。

在【示例4-15】中列举了一些常见的示例。

【示例4-15】

\#以源地址作为路由依据

ip rule add from 192.168.19.0/24 table testl ip rule add from 192.168.17.100/32 table testl #以源地址和tos作为路由依据

ip rule add from X92.168.0.0/16 tos 0x10 table testl #以目标地址作为路由依据

ip route add to 192.168.100.100/32 table testl ip route add to 192.168.101.0/24 table testl #以防火墙标记为路由依据，需要防火墙使用选项set-mark标记 ip rule add fwmark 1 table 1

2.路由管理

与之前介绍的使用route命令添加路由相比，策略路由的路由管理稍稍复杂一些，其格式 如下所示：

ip route add ipaddress via ipaddressl table table一name

其中ipaddress参数表示网络号，via选项指定的参数ipaddressl表示网关ip地址，即下一 跳地址，table name表示路由表名。

一些比较常见的路由条目如【示例4-16】所示。

【示例4-16】

\#添加到testl的默认路由

ip route add default via 192.168.11.1 table testl 番发往192.168,15 • 0/24网络的包下一跳地址是1犯.168.11.1" ip route add 192.168.15.0/24 via 192.168.11.1 table testl

4.3.4策略路由应用实例

在前面几个小节中，介绍了 Linux系统的策略路由的运作机制，本小节将通过几个实例介 绍策略路由的应用。

在本小节的例子中，Linux主机连接了两个子网：192.168.1.0/24及192.168.2.0/24,拥有 两个出口：第一个是172.16.33.2,对端网关为172.16.33.1；另一个为172.16.34.2,对端网关为 172,16.34.1,如图 4.8 所示。

需要说明的是出口及对端网关地址应为网络供应商提供的公网IP地址，此处出于安全考 虑以私网地址代替，其配置过程仅需将IP地址等信息替换即可，其他并无不同之处。

内部子网接口 1: enoS0332208 ip 192.168.U



互联网出口h cnol6777736 - ip； 172.16.33.2

对端网关：17246.33.1



内部子网



![img](11 CentOS7fbdfa1060ed0f49e18-76.jpg)



互联网



内部子网接口2: cno67109432 ip: 192.168.2.1 ~



互联网出口2: eno33554984 一-ip$ t72.l<U4.2

对衊网关：扇72.覆6.34.重



图4.8策略路由拓扑

1.选择出口

如图4.8所示网络结构，现有两个出口，其中互联网出口 1为所有内部子网的默认出口， 出口 2比出口 1速度更快，但仅供内部网络中的VIP用户使用。现假定有VIP用户的IP地址 为：192.168.1.52和192.168.2.54,现需要配置这两个地址的流量，使用出口 2以获得更快的速 度。

(1)    配置默认路由

根据以上信息先配置接口 enol6777736,将IP地址，默认网关等信息一并设置，而出口 2 仅正确设置IP地址及子网掩码即可，无须设置默认网关。关于这些设置读者可自行参考第3 章中的相关内容，此处不再赘述。

(2)    配置策略路由

在上一步配置中已将所有子网的数据包的转发出口设置为出口 1,现在需要配置VIP用户 的数据包从出口 2进行转发，其配置方法如【示例4-17】所示。

【示例4-17】

\#建乂路由表T1

(rootslocalhost ~3 # echo 200 T1 » /etc/iproute2/rt_tables #设置VIP用户的数据包使用路由表T：[路由 [root@localbost *-] # ip rule add from 192 [root@localhost ~]# ip rule add from 192 [root@localhost -]# ip rule Is 0:    from all lookup local

168.1.52/32 table T1 168.2.54/32 table T1



32764: from 192,168.2.54 lookup T1 32765: from 192,168.1.52 lookup T1 32766: from all lookup main 32767: from all lookup default #为路*表添加出口2的默认路由

[root@localhost H # ip route add default via 172.16,34.1 table T1 [rootQlocalhost -]# ip route list table T1 default via 172.16.34.1 dev eno33554984

以上是整个配置过程，但以上配置在系统重启后会消失，因此需要添加规则，将添加路由 表T1默认路由的语句写入/etc/rc.local中。

2.负载均衡

负载均衡的配置方法与选择出口的配置方法略有不同，因为负载均衡时需要考虑一个新的 问题，需要保证连接的持续性。即从互联网出口1进来的数据包返回时也从出口1返回；出口 2亦相同。负载均衡的配置方法如【示例4-18】所示。

【示例4-18】

\#添加两个路由表tablel和table2

![img](11 CentOS7fbdfa1060ed0f49e18-77.jpg)



[root^localhost echo 100 tablel » /Gtc/iproute2/rt__tables [root@localhost -3 # echo 200 table2 >> /etc/iproute2/rt_tables

\#分别添加返回路由

[root@localhost 〜# ip route add default via 172.16.33.1 dev enol6777736

172.16.33.2 tablel    /    :人，.'/    .

[root@localhost -3 # ip rule add from 172.16.33.2 table tablel froot@localhost # ip route add default via 172.16.34.1 dev eno33554984

172,16,34.2 table?

(root^localhost # ip rule add. from 17^.16.34.2 table table2 #设置负载均衡策略



'    ■    .j    ■    ■    :    .    ■ .    ■.

[rootsloqalhost 〜ip route add default scope global nexthop via 172.16.33*2 dev enol6777736 weight 1 netxthop via 172.16.34.2 dev eno33554984 weight 1

在上面的示例中，weight用于指定出口的权重，此处都设置为1表示平等对待，如果需要 区别对待可以修改此值=与之前的设置方法相同，如果需要设置在重启后仍然生效，可以将规 则和路由添加到文件/etc/rc.local中。

本小节仅讨论了策略路由如何实施，并没有包含诸如NAT等问题，关于路由器转发相关 内容可参考4.2节中的相关内容。

###### 4.4小结

路由是Linux系统中相当重要的内容，本章从实际应用出发主要介绍了 Linux系统的路由 相关内容，通过实例介绍了传统路由的设置，数据包转发等内容。对于Linux上的策略路由问 题，剖析了 Linux策略路由的运作机制，并通过实例介绍了策略路由的应用。

W.

gHiMMi    KhmS

4F ■ w

:    ' ,    '    -' lr'.' +\    .................-I .- I • ■ -    ■；    T^>    .77^*.    ，-    ,-.^：    '    .    .    ■圓圓    j.
